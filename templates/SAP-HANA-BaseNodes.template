AWSTemplateFormatVersion: '2010-09-09'
Description: (qs-1qup6rak7) Deploy SAP HANA on AWS
Parameters:
  VPCID:
    Description: The existing Amazon VPC where you want to deploy SAP HANA.
    Type: AWS::EC2::VPC::Id
  PrivSubCIDR:
    Description: CIDR block of the private subnet where SAP HANA will be deployed.
    Type: String
    Default: 10.0.1.0/24
    AllowedPattern: ^(([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])\.){3}([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])(\/([0-9]|[1-2][0-9]|3[0-2]))$
  DMZCIDR:
    Description: CIDR block of the public DMZ subnet where BASTION Host / NAT Gateway
      exist.
    Type: String
    Default: 10.0.2.0/24
    AllowedPattern: ^(([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])\.){3}([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])(\/([0-9]|[1-2][0-9]|3[0-2]))$
  RemoteAccessCIDR:
    Description: CIDR block from where you want to access your RDP instance.
    Type: String
    Default: '0.0.0.0/0'
    AllowedPattern: ^(([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])\.){3}([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])(\/([0-9]|[1-2][0-9]|3[0-2]))$
    ConstraintDescription: This must be a valid CIDR range in the format x.x.x.x/x.
  HANASubnet:
    Type: AWS::EC2::Subnet::Id
    Description: The existing private subnet in your VPC where you want to deploy
      SAP HANA.
  ApplicationCIDR:
    Description: CIDR block of subnet where SAP Application servers are deployed.
    Type: String
    AllowedPattern: ^(([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])\.){3}([0-9]|[1-9][0-9]|1[0-9]{2}|2[0-4][0-9]|25[0-5])(\/([0-9]|[1-2][0-9]|3[0-2]))$
    Default: '0.0.0.0/0'
    ConstraintDescription: This must be a valid CIDR range in the format x.x.x.x/x.
  DMZSubnet:
    Type: AWS::EC2::Subnet::Id
    Description: The existing public subnet in your VPC where you want to deploy the
      optional RDP instance.
  DomainName:
    Type: String
    Description: Name to use for fully qualified domain names.
    Default: local
  HANAMasterHostname:
    Type: String
    Description: Host name to use for SAP HANA master node (DNS short name).
    Default: imdbmaster
  HANAWorkerHostname:
    Type: String
    Description: Host name to use for SAP HANA worker node(s) (DNS short name).
    Default: imdbworker
  PlacementGroupName:
    Type: String
    Default: ''
    Description: Name of an existing placement group where SAP HANA should be deployed
      (for scale-out deployments.
  PrivateBucket:
    Description: Main build bucket where templates and scripts are located.
    Type: String
    Default: aws-quickstart/quickstart-sap-hana
  CustomStorageConfig:
    Description: S3 location where custom storage configuration file is localted.
    Type: String
    Default: aws-quickstart/quickstart-sap-hana/scripts
  Proxy:
    Description: Proxy address for http access (e.g., http://xyz.abc.com:8080 or http://10.x.x.x:8080).
    Type: String
    Default: ''
  KeyName:
    Type: AWS::EC2::KeyPair::KeyName
    Default: home
    Description: Name of an existing Amazon EC2 key pair. All instances will launch
      with this key pair.
  HANAInstallMedia:
    Description: Full path to Amazon S3 location of SAP HANA software files (e.g.,
      s3://myhanabucket/sap-hana-sps11/).
    Type: String
    Default: ''
  EnableLogging:
    Description: Enable (Yes) or disable (No) logging with AWS CloudTrail and AWS
      Config.
    Default: 'No'
    Type: String
    AllowedValues:
      - 'Yes'
      - 'No'
  CloudTrailS3Bucket:
    Description: Name of S3 bucket where AWS CloudTrail trails and AWS Config log
      files can be stored (e.g., mycloudtrail).
    Default: ''
    Type: String
  AutoRecovery:
    Type: String
    Description: Enable (Yes) or disable (No) automatic recovery feature for SAP HANA
      nodes. Disable it for Dedicated Host Deployments
    Default: 'Yes'
    AllowedValues:
      - 'Yes'
      - 'No'
  AWSEFS:
    Type: String
    Description: Use (Yes) or don't use (No) Amazon EFS for HANA shared file system.
    Default: 'Yes'
    AllowedValues:
      - 'Yes'
      - 'No'
  SAPHANAFastRestart:
    Type: String
    Description: Enable (Yes) or disable (No) SAP HANA Fast Restart.
    Default: 'No'
    AllowedValues:
      - 'Yes'
      - 'No'
  AutomaticReboot:
    Type: String
    Description: Enable (Yes) or disable (No) automatic instance reboot
    Default: 'No'
    AllowedValues:
      - 'Yes'
      - 'No'
  Encryption:
    Type: String
    Description: Enable (Yes) or disable (No) encryption on EBS volumes.
    Default: 'No'
    AllowedValues:
      - 'Yes'
      - 'No'
  VolumeTypeHanaData:
    Type: String
    Description: 'EBS volume type for SAP HANA Data: General Purpose SSD (gp2) or
      Provisioned IOPS SSD (io1).'
    Default: gp2
    AllowedValues:
      - gp2
      - io1
      - io2
  VolumeTypeHanaLog:
    Type: String
    Description: 'EBS volume type for SAP HANA Log: General Purpose SSD (gp2) or Provisioned
      IOPS SSD (io1).'
    Default: gp2
    AllowedValues:
      - gp2
      - io1
      - io2
  MyOS:
    Type: String
    Description: Operating system (SLES or RHEL) and version for master and worker
      nodes.
    Default: SuSELinux12SP4ForSAP
    AllowedValues:
      - RedHatLinux75ForSAP
      - RedHatLinux74ForSAP-With-HA-US
      - RedHatLinux75ForSAP-With-HA-US
      - RedHatLinux76ForSAP-With-HA-US
      - RedHatLinux77ForSAP-With-HA-US
      - RedHatLinux79ForSAP-With-HA-US
      - RedHatLinux81ForSAP-With-HA-US
      - RedHatLinux82ForSAP-With-HA-US
      - SuSELinux11SP4
      - SuSELinux12SP1
      - SuSELinux12SP3
      - SuSELinux12SP4
      - SuSELinux12SP5
      - SuSELinux15
      - SuSELinux15SP1
      - SuSELinux15SP2
      - SuSELinux15SP3
      - SuSELinux12SP2ForSAP
      - SuSELinux12SP3ForSAP
      - SuSELinux12SP4ForSAP
      - SuSELinux12SP5ForSAP
      - SuSELinux15ForSAP
      - SuSELinux15SP1ForSAP
      - SuSELinux15SP2ForSAP
      - SuSELinux15SP3ForSAP
      - SuSELinux12SP1ForSAP-BYOS
      - SuSELinux12SP2ForSAP-BYOS
      - SuSELinux12SP3ForSAP-BYOS
      - SuSELinux12SP4ForSAP-BYOS
      - SuSELinux12SP5ForSAP-BYOS
      - SuSELinux15ForSAP-BYOS
      - SuSELinux15SP1ForSAP-BYOS
      - SuSELinux15SP2ForSAP-BYOS
      - SuSELinux15SP3ForSAP-BYOS
  SLESBYOSRegCode:
    Type: String
    Default: ''
    Description: Registration code for SUSE BYOS (Applicable only if you use BYOS
      Option).
    NoEcho: 'true'
  InstallRDPInstance:
    Type: String
    Description: Install (Yes) or don't install (No) optional Windows RDP instance.
    Default: 'No'
    AllowedValues:
      - 'Yes'
      - 'No'
  InstallHANA:
    Type: String
    Description: Install (Yes) or don't install (No) HANA. When set to No, only AWS
      infrastructure is provisioned.
    Default: 'Yes'
    AllowedValues:
      - 'Yes'
      - 'No'
  RDPInstanceType:
    Type: String
    Description: Instance type for Windows RDP instance.
    Default: c5.large
    AllowedValues:
      - c4.large
      - c4.xlarge
      - c5.large
      - c5.xlarge
      - m4.large
      - m4.xlarge
      - m5.large
      - m5.xlarge
  MyInstanceType:
    Type: String
    Description: Instance type for SAP HANA host.
    Default: r5.2xlarge
    AllowedValues:
      - r3.8xlarge
      - r3.4xlarge
      - r3.2xlarge
      - r4.16xlarge
      - r4.8xlarge
      - r4.4xlarge
      - r4.2xlarge
      - r5.2xlarge
      - r5.4xlarge
      - r5.8xlarge
      - r5.12xlarge
      - r5.16xlarge
      - r5.24xlarge
      - r5.metal
      - r5b.2xlarge
      - r5b.4xlarge
      - r5b.8xlarge
      - r5b.12xlarge
      - r5b.16xlarge
      - r5b.24xlarge
      - r5b.metal
      - x1.16xlarge
      - x1.32xlarge
      - x1e.xlarge
      - x1e.2xlarge
      - x1e.4xlarge
      - x1e.32xlarge
      - u-6tb1.56xlarge
      - u-6tb1.112xlarge
      - u-6tb1.metal
      - u-9tb1.metal
      - u-9tb1.112xlarge
      - u-12tb1.metal
      - u-12tb1.112xlarge
      - u-18tb1.metal
      - u-24tb1.metal
  DedicatedHostId:
    Type: CommaDelimitedList
    Description: Existing dedicated host(s) where you want to launch your EC2 instance(s).
      Use comma to provide multiple hosts. Mandatory for Amazon EC2 High Memory Instances.
    Default: ''
  HostCount:
    Type: Number
    Description: Total number of SAP HANA nodes you want to deploy in the SAP HANA
      cluster.
    Default: '1'
    MinValue: '1'
    MaxValue: '5'
  SID:
    Type: String
    Default: HDB
    Description: SAP HANA system ID for installation and setup.
    AllowedPattern: ([A-Z]{1}[0-9A-Z]{2})
    ConstraintDescription: This value must consist of 3 characters.
  SAPInstanceNum:
    Type: String
    Default: '00'
    Description: SAP HANA instance number to use for installation and setup, and to
      open ports for security groups.
    AllowedPattern: ([0-8]{1}[0-9]{1}|[9]{1}[0-7]{1})
    ConstraintDescription: Instance number must be between 00 and 97.
  HANAMasterPass:
    Type: String
    Description: SAP HANA password to use during installation. Must be at least 8
      characters with uppercase, lowercase, and numeric values.
    NoEcho: 'true'
    MinLength: '8'
    AllowedPattern: ^(?=.*?[a-z])(?=.*?[A-Z])(?=.*[0-9]).*
    ConstraintDescription: This must be at least 8 characters, including uppercase,
      lowercase, and numeric values.
  SAPTZ:
    AllowedValues:
      - CT
      - ET
      - JT
      - PT
      - UC
    ConstraintDescription: This value must consist of 2 characters.
    Default: UC
    Description: The TimeZone of your SAP HANA Server (PT, CT, ET, or UTC)
    Type: String
  LatestWS2012AmiId:
    Type: AWS::SSM::Parameter::Value<AWS::EC2::Image::Id>
    Default: /aws/service/ami-windows-latest/Windows_Server-2012-R2_RTM-English-64Bit-Base
    Description: Do not change. Fetch latest Windows Server 2012 image id.
    AllowedValues:
      - /aws/service/ami-windows-latest/Windows_Server-2012-R2_RTM-English-64Bit-Base
Metadata:
  AWSAMIRegionMap:
    Filters:
      RHEL75SAPHVM:
        name: SAP-7.5_HVM_GA-????????-x86_64-0-Hourly2-GP2-b676039c-a4f8-4be7-9866-c804b1ade684-*
        owner-alias: aws-marketplace
      RHEL74SAPHAUSHVM:
        name: SAPHAE4S-7.4_HVM-????????-x86_64-2-Hourly2-GP2-5cca0aac-b678-4e46-80e2-344cfed26a62-*
        owner-alias: aws-marketplace
      RHEL75SAPHAUSHVM:
        name: SAPHAEUS-7.5_HVM-????????-x86_64-2-Hourly2-GP2-5cca0aac-b678-4e46-80e2-344cfed26a62-*
        owner-alias: aws-marketplace
      RHEL76SAPHAUSHVM:
        name: SAP-7.6_E4S_HA_US_HVM-????????-x86_64-2-Hourly2-GP2-5cca0aac-b678-4e46-80e2-344cfed26a62-*
        owner-alias: aws-marketplace
      SLES12SP2SAPHVM:
        name: '*-e3458d64-5c36-4577-bd98-0ee19e3eaeec-*'
        owner-alias: aws-marketplace
      SLES12SP3SAPHVM:
        name: '*-da7aa9c3-97db-4573-89a6-7fe7348d90b0-*'
        owner-alias: aws-marketplace
      SLES12SP4SAPHVM:
        name: '*-8f7bb679-fb90-4446-aa80-9b6cfd834710-*'
        owner-alias: aws-marketplace
      SLES12SP5SAPHVM:
        name: '*--487d036f-ab18-4fbd-8264-f714c004b0b1-*'
      SLES15SAPHVM:
        name: '*-6a4bc5af-a084-4f96-8402-5cd249e9091d-*'
        owner-alias: aws-marketplace
      SLES15SP1SAPHVM:
        name: '*-36451a0a-c7b9-4ee2-bb36-1192921c6337-*'
  AWS::CloudFormation::Interface:
    ParameterGroups:
      - Label:
          default: Existing network infrastructure details
        Parameters:
          - VPCID
          - HANASubnet
          - DMZSubnet
          - PrivSubCIDR
          - DMZCIDR
      - Label:
          default: Server and storage configuration
        Parameters:
          - MyOS
          - SLESBYOSRegCode
          - MyInstanceType
          - HostCount
          - DedicatedHostId
          - AutoRecovery
          - KeyName
          - VolumeTypeHanaData
          - VolumeTypeHanaLog
          - AWSEFS
          - Encryption
          - AutomaticReboot
      - Label:
          default: SAP HANA database configuration
        Parameters:
          - DomainName
          - HANAMasterHostname
          - HANAWorkerHostname
          - SID
          - SAPInstanceNum
          - HANAMasterPass
          - SAPTZ
          - HANAInstallMedia
          - InstallHANA
          - SAPHANAFastRestart
      - Label:
          default: Optional configuration
        Parameters:
          - PlacementGroupName
          - InstallRDPInstance
          - RDPInstanceType
          - RemoteAccessCIDR
          - ApplicationCIDR
          - EnableLogging
          - CloudTrailS3Bucket
          - Proxy
      - Label:
          default: Advanced configuration (Do not modify unless directed by AWS Support)
        Parameters:
          - PrivateBucket
          - CustomStorageConfig
          - LatestWS2012AmiId
    ParameterLabels:
      VPCID:
        default: Choose VPC ID
      PrivSubCIDR:
        default: Enter CIDR block for private subnet
      DMZSubnet:
        default: Choose public subnet
      DMZCIDR:
        default: Enter CIDR block for public subnet
      HANASubnet:
        default: Choose private subnet
      RemoteAccessCIDR:
        default: Enter CIDR block for RDP access
      DomainName:
        default: Enter domain name
      HANAMasterHostname:
        default: Enter SAP HANA master host name
      HANAWorkerHostname:
        default: Enter SAP HANA worker host name
      HANAInstallMedia:
        default: Enter Amazon S3 URL for SAP HANA software
      CloudTrailS3Bucket:
        default: Enter S3 bucket name to store AWS CloudTrail trails and AWS Config
          logs
      PlacementGroupName:
        default: Enter optional placement group name
      DedicatedHostId:
        default: Enter Dedicated Host ID
      PrivateBucket:
        default: Enter private bucket
      CustomStorageConfig:
        default: Enter custom storage configuration location
      Proxy:
        default: Enter proxy server address
      KeyName:
        default: Choose key pair
      AutoRecovery:
        default: Would you like to turn on automatic recovery?
      InstallRDPInstance:
        default: Do you need a Windows RDP instance?
      InstallHANA:
        default: Install SAP HANA software?
      AWSEFS:
        default: Would you like to use Amazon EFS?
      Encryption:
        default: Would you like to turn on encryption?
      VolumeTypeHanaData:
        default: Choose storage volume type for SAP HANA Data
      VolumeTypeHanaLog:
        default: Choose storage volume type for SAP HANA Log
      MyOS:
        default: Choose operating system for SAP HANA
      SLESBYOSRegCode:
        default: Enter SUSE BYOS Registration Code
      MyInstanceType:
        default: Choose instance type for SAP HANA
      HostCount:
        default: Enter number of SAP HANA hosts
      SID:
        default: Enter SAP HANA system ID
      SAPInstanceNum:
        default: Enter SAP HANA instance number
      HANAMasterPass:
        default: Enter SAP HANA password
      SAPHANAFastRestart:
        default: Would you like to enable SAP HANA Fast Restart?
      AutomaticReboot:
        default: Would you like to have the SAP HANA instance automatically rebooted?
      RDPInstanceType:
        default: Choose instance type for RDP host
      EnableLogging:
        default: Would you like to enable AWS CloudTrail trails and AWS Config?
      SAPTZ:
        default: Enter SAP HANA Server timezone
      ApplicationCIDR:
        default: Enter CIDR block of your SAP Application Servers
      LatestWS2012AmiId:
        default: WS2012R2 AMI ID SSM Parameter
  cfn-lint:
    config:
      ignore_checks:
        - E9007
        - E9010
        - E9101
        - W1001
        - W2001
        - W3005
        - W8001
Conditions:
  TwoOrMoreNodes: !Or
    - !Equals
      - '2'
      - !Ref 'HostCount'
    - !Equals
      - '3'
      - !Ref 'HostCount'
    - !Equals
      - '4'
      - !Ref 'HostCount'
    - !Equals
      - '5'
      - !Ref 'HostCount'
    - !Equals
      - '6'
      - !Ref 'HostCount'
  ThreeOrMoreNodes: !Or
    - !Equals
      - '3'
      - !Ref 'HostCount'
    - !Equals
      - '4'
      - !Ref 'HostCount'
    - !Equals
      - '5'
      - !Ref 'HostCount'
    - !Equals
      - '6'
      - !Ref 'HostCount'
  FourOrMoreNodes: !Or
    - !Equals
      - '4'
      - !Ref 'HostCount'
    - !Equals
      - '5'
      - !Ref 'HostCount'
    - !Equals
      - '6'
      - !Ref 'HostCount'
  FiveOrMoreNodes: !Or
    - !Equals
      - '5'
      - !Ref 'HostCount'
    - !Equals
      - '6'
      - !Ref 'HostCount'
  SixOrMoreNodes: !Or
    - !Equals
      - '6'
      - !Ref 'HostCount'
    - !Equals
      - '7'
      - !Ref 'HostCount'
  AutoRecoveryWorker1: !And
    - !Equals
      - 'Yes'
      - !Ref 'AutoRecovery'
    - !Condition 'TwoOrMoreNodes'
  AutoRecoveryWorker2: !And
    - !Equals
      - 'Yes'
      - !Ref 'AutoRecovery'
    - !Condition 'ThreeOrMoreNodes'
  AutoRecoveryWorker3: !And
    - !Equals
      - 'Yes'
      - !Ref 'AutoRecovery'
    - !Condition 'FourOrMoreNodes'
  AutoRecoveryWorker4: !And
    - !Equals
      - 'Yes'
      - !Ref 'AutoRecovery'
    - !Condition 'FiveOrMoreNodes'
  AutoRecoveryWorker5: !And
    - !Equals
      - 'Yes'
      - !Ref 'AutoRecovery'
    - !Condition 'SixOrMoreNodes'
  AutoRecoveryMaster: !Equals
    - !Ref 'AutoRecovery'
    - 'Yes'
  NeedWindowsInstance: !Equals
    - !Ref 'InstallRDPInstance'
    - 'Yes'
  PlacementGroupNull: !Equals
    - !Ref 'PlacementGroupName'
    - ''
  UseEFS: !And
  - !Equals
    - 'Yes'
    - !Ref 'AWSEFS'
  - !Condition 'TwoOrMoreNodes'
  NoUseEFS: !Or
  - !Equals
    - 'No'
    - !Ref 'AWSEFS'
  - !Not
    - !Condition 'TwoOrMoreNodes'
  UseSAPHANAFR: !Equals
    - 'Yes'
    - !Ref 'SAPHANAFastRestart'
  UseEncryption: !Equals
    - !Ref 'Encryption'
    - 'Yes'
  IfDedicatedHost: !Not
    - !Equals
      - !Select
        - '0'
        - !Ref 'DedicatedHostId'
      - ''
  IfLogging: !Equals
    - !Ref 'EnableLogging'
    - 'Yes'
  IfAppSubnet: !Not
    - !Equals
      - !Ref 'ApplicationCIDR'
      - '0.0.0.0/0'
  IfUseSLES: !Equals
    - !FindInMap
      - SAPAMINameMap
      - !Ref 'MyOS'
      - Code
    - SLES
Mappings:
  SAPAMINameMap:
    RedHatLinux75ForSAP:
      Code: RHEL75SAPHVM
    RedHatLinux74ForSAP-With-HA-US:
      Code: RHEL74SAPHAUSHVM
    RedHatLinux75ForSAP-With-HA-US:
      Code: RHEL75SAPHAUSHVM
    RedHatLinux76ForSAP-With-HA-US:
      Code: RHEL76SAPHAUSHVM
    RedHatLinux77ForSAP-With-HA-US:
      Code: RHEL77SAPHAUSHVM
    RedHatLinux79ForSAP-With-HA-US:
      Code: RHEL79SAPHAUSHVM
    RedHatLinux81ForSAP-With-HA-US:
      Code: RHEL81SAPHAUSHVM
    RedHatLinux82ForSAP-With-HA-US:
      Code: RHEL82SAPHAUSHVM
    SuSELinux11SP4:
      Code: SLES11SP4HVM
    SuSELinux12SP1:
      Code: SLES12SP1HVM
    SuSELinux12SP2:
      Code: SLES12SP2HVM
    SuSELinux12SP3:
      Code: SLES12SP3HVM
    SuSELinux12SP4:
      Code: SLES12SP4HVM
    SuSELinux12SP5:
      Code: SLES12SP5HVM
    SuSELinux15:
      Code: SLES15HVM
    SuSELinux15SP1:
      Code: SLES15SP1HVM
    SuSELinux15SP2:
      Code: SLES15SP2HVM
    SuSELinux15SP3:
      Code: SLES15SP3HVM
    SuSELinux12SP2ForSAP:
      Code: SLES12SP2SAPHVM
    SuSELinux12SP3ForSAP:
      Code: SLES12SP3SAPHVM
    SuSELinux12SP4ForSAP:
      Code: SLES12SP4SAPHVM
    SuSELinux12SP5ForSAP:
      Code: SLES12SP5SAPHVM
    SuSELinux15ForSAP:
      Code: SLES15SAPHVM
    SuSELinux15SP1ForSAP:
      Code: SLES15SP1SAPHVM
    SuSELinux15SP2ForSAP:
      Code: SLES15SP2SAPHVM
    SuSELinux15SP3ForSAP:
      Code: SLES15SP3SAPHVM
    SuSELinux12SP1ForSAP-BYOS:
      Code: SLES12SP1SAPBYOSHVM
    SuSELinux12SP2ForSAP-BYOS:
      Code: SLES12SP2SAPBYOSHVM
    SuSELinux12SP3ForSAP-BYOS:
      Code: SLES12SP3SAPBYOSHVM
    SuSELinux12SP4ForSAP-BYOS:
      Code: SLES12SP4SAPBYOSHVM
    SuSELinux12SP5ForSAP-BYOS:
      Code: SLES12SP5SAPBYOSHVM
    SuSELinux15ForSAP-BYOS:
      Code: SLES15SAPBYOSHVM
    SuSELinux15SP1ForSAP-BYOS:
      Code: SLES15SP1SAPBYOSHVM
    SuSELinux15SP2ForSAP-BYOS:
      Code: SLES15SP2SAPBYOSHVM
    SuSELinux15SP3ForSAP-BYOS:
      Code: SLES15SP3SAPBYOSHVM
  AWSAMIRegionMap:
    AMI:
      RHEL75SAPHVM: SAP-7.5_HVM_GA-20180911-x86_64-0-Hourly2-GP2-b676039c-a4f8-4be7-9866-c804b1ade684-ami-01e5a531ae8d3d976.4
      RHEL74SAPHAUSHVM: SAPHAE4S-7.4_HVM-20181108-x86_64-2-Hourly2-GP2-5cca0aac-b678-4e46-80e2-344cfed26a62-ami-0c3e857ffeab71ac5.4
      RHEL75SAPHAUSHVM: SAPHAEUS-7.5_HVM-20181108-x86_64-2-Hourly2-GP2-5cca0aac-b678-4e46-80e2-344cfed26a62-ami-081c0b27c08752050.4
      RHEL76SAPHAUSHVM: SAP-7.6_E4S_HA_US_HVM-20190221-x86_64-2-Hourly2-GP2-5cca0aac-b678-4e46-80e2-344cfed26a62-ami-0e49c67162a6956e9.4
      RHEL77SAPHAUSHVM: RHEL-SAP-7.7_HVM-20210127-x86_64-0-Hourly2-GP2-a0debecb-e593-433b-a0cb-24d2b77ecb43-ami-00131435b1032a45d.4
      RHEL79SAPHAUSHVM: RHEL-SAP-7.9_HVM-20210316-x86_64-0-Hourly2-GP2-d6d15031-041e-47b2-adde-74cd2a176289-ami-0380335543eedc0b9.4
      RHEL81SAPHAUSHVM: RHEL-8.1.0-SAP-HVM-20191029-x86_64-0-Hourly2-GP2-cb6ddc00-bd33-4b75-be77-613adc547551-ami-01980716e7ae51e97.4
      RHEL82SAPHAUSHVM: RHEL-8.2.0-SAP-HVM-20200423-x86_64-0-Hourly2-GP2-810c9d2d-afed-4183-99cc-9280d1684740-ami-024b797e6240416aa.4
      SLES11SP4HVM: suse-sles-11-sp4-v20180816-hvm-ssd-x86_64
      SLES12SP1HVM: suse-sles-12-sp1-v20161021-hvm-ssd-x86_64
      SLES12SP2HVM: suse-sles-12-sp2-v20170620-hvm-ssd-x86_64
      SLES12SP3HVM: suse-sles-12-sp3-v20181004-hvm-ssd-x86_64
      SLES12SP4HVM: suse-sles-12-sp4-v20190314-hvm-ssd-x86_64
      SLES12SP5HVM: suse-sles-12-sp5-v20200527-hvm-ssd-x86_64
      SLES15HVM: suse-sles-15-v20180806-hvm-ssd-x86_64
      SLES15SP1HVM: suse-sles-15-sp1-v20200226-hvm-ssd-x86_64
      SLES15SP2HVM: suse-sles-15-sp2-v20200721-hvm-ssd-x86_64
      SLES15SP3HVM: suse-sles-15-sp3-v20210622-hvm-ssd-x86_64
      SLES12SP2SAPHVM: suse-sles-sap-12-sp2-v20180706-hvm-ssd-x86_64-e3458d64-5c36-4577-bd98-0ee19e3eaeec-ami-3ac5ea45.4
      SLES12SP3SAPHVM: suse-sles-sap-12-sp3-v20180814-hvm-ssd-x86_64-da7aa9c3-97db-4573-89a6-7fe7348d90b0-ami-0df5b06332b816a8e.4
      SLES12SP4SAPHVM: suse-sles-sap-12-sp4-v20181212-hvm-ssd-x86_64-8f7bb679-fb90-4446-aa80-9b6cfd834710-ami-015bf44384c484ccb.4
      SLES12SP5SAPHVM: suse-sles-sap-12-sp5-v202006010-hvm-ssd-x86_64-487d036f-ab18-4fbd-8264-f714c004b0b1-ami-0fdfc70d53ae63cbe.4
      SLES15SAPHVM: suse-sles-sap-15-v20180806-hvm-ssd-x86_64-6a4bc5af-a084-4f96-8402-5cd249e9091d-ami-06aee2e6db735d4f4.4
      SLES15SP1SAPHVM: suse-sles-sap-15-sp1-v20200527-hvm-ssd-x86_64-36451a0a-c7b9-4ee2-bb36-1192921c6337-ami-02db89093d1dc48ca.4
      SLES15SP2SAPHVM: suse-sles-sap-15-sp2-v20200721-hvm-ssd-x86_64-e9701ac9-43ee-4dda-b944-17c6c231c8db-ami-0815c103582dd3bae.4
      SLES15SP3SAPHVM: suse-sles-sap-15-sp3-v20210623-hvm-ssd-x86_64-830d483c-5618-40d8-b3b5-7aad295a278c-ami-0e3b4dbf9c2cd8b16.4
      SLES12SP1SAPBYOSHVM: suse-sles-sap-12-sp1-byos-v20170123-hvm-ssd-x86_64
      SLES12SP2SAPBYOSHVM: suse-sles-sap-12-sp2-byos-v20180816-hvm-ssd-x86_64
      SLES12SP3SAPBYOSHVM: suse-sles-sap-12-sp3-byos-v20180814-hvm-ssd-x86_64
      SLES12SP4SAPBYOSHVM: suse-sles-sap-12-sp4-byos-v20190314-hvm-ssd-x86_64
      SLES12SP5SAPBYOSHVM: suse-sles-sap-12-sp5-byos-v20200527-hvm-ssd-x86_64
      SLES15SAPBYOSHVM: suse-sles-sap-15-byos-v20180816-hvm-ssd-x86_64
      SLES15SP1SAPBYOSHVM: suse-sles-sap-15-sp1-byos-v20200506-hvm-ssd-x86_64
      SLES15SP2SAPBYOSHVM: suse-sles-sap-15-sp2-byos-v20200721-hvm-ssd-x86_64
      SLES15SP3SAPBYOSHVM: suse-sles-sap-15-sp3-byos-v20210623-hvm-ssd-x86_64
    ap-northeast-1:
      RHEL75SAPHVM: ami-0ce47f39a0a21f61e
      RHEL74SAPHAUSHVM: ami-0033f0d7d626f014f
      RHEL75SAPHAUSHVM: ami-08d13c2bb0c07e8e3
      RHEL76SAPHAUSHVM: ami-092eb64b443171d7e
      RHEL77SAPHAUSHVM: ami-04568f34660e8071e
      RHEL79SAPHAUSHVM: ami-0797614c936404427
      RHEL81SAPHAUSHVM: ami-0c1631b0e1534a6c6
      RHEL82SAPHAUSHVM: ami-0d8e63ef1a48c7bdc
      SLES11SP4HVM: ami-0c6f393bb8d20159a
      SLES12SP1HVM: ami-d94fe9b8
      SLES12SP1SAPBYOSHVM: ami-63473c04
      SLES12SP2HVM: ami-a07560c7
      SLES12SP2SAPBYOSHVM: ami-0cd358eaaf4cfca8f
      SLES12SP2SAPHVM: ami-0473f61d700f976bd
      SLES12SP3HVM: ami-050f5170e43607893
      SLES12SP3SAPBYOSHVM: ami-046ba88845aa11793
      SLES12SP3SAPHVM: ami-0b8f8f9b74113860d
      SLES12SP4HVM: ami-01f9388175dab7707
      SLES12SP4SAPBYOSHVM: ami-0f23448ff16bda87c
      SLES12SP4SAPHVM: ami-08b12d52001226654
      SLES12SP5HVM: ami-04882bf72ff913721
      SLES12SP5SAPHVM: ami-0ce7ae6d6cbed7cde
      SLES12SP5SAPBYOSHVM: ami-03758691846e8fe66
      SLES15HVM: ami-056ac8ad44e6a7e1f
      SLES15SAPHVM: ami-0174751ba72376df1
      SLES15SAPBYOSHVM: ami-0a283a879655ea8ad
      SLES15SP1HVM: ami-0dae5fda3ab8726c3
      SLES15SP1SAPHVM: ami-0fe3654624dabaeba
      SLES15SP1SAPBYOSHVM: ami-01e60bcfb844303c6
      SLES15SP2HVM: ami-0119d7d47f3b13adb
      SLES15SP2SAPHVM: ami-0745236d3079b152b
      SLES15SP2SAPBYOSHVM: ami-0da403cbfd6386067
      SLES15SP3HVM: ami-07adb9597130f7b27
      SLES15SP3SAPHVM: ami-000641e3014f4be79
      SLES15SP3SAPBYOSHVM: ami-0d1ca9565726f1931
    ap-northeast-2:
      RHEL75SAPHVM: ami-06db50be1842d6b9a
      RHEL74SAPHAUSHVM: ami-0450ac5a5b079fa41
      RHEL75SAPHAUSHVM: ami-0521b6ebbf151e58a
      RHEL76SAPHAUSHVM: ami-04384779af6b49648
      RHEL77SAPHAUSHVM: ami-0170a0c8dcfe3dc58
      RHEL79SAPHAUSHVM: ami-022985fe1dad2da39
      RHEL81SAPHAUSHVM: ami-0cb4250a1ecedeacd
      RHEL82SAPHAUSHVM: ami-0de858da3b072b166
      SLES11SP4HVM: ami-00e7068674ce94853
      SLES12SP1HVM: ami-1ced3972
      SLES12SP1SAPBYOSHVM: ami-b5f928db
      SLES12SP2HVM: ami-86d00fe8
      SLES12SP2SAPBYOSHVM: ami-0aa17e547c74ef870
      SLES12SP2SAPHVM: ami-06156767035d49b64
      SLES12SP3HVM: ami-00728f974fb4b3f2a
      SLES12SP3SAPBYOSHVM: ami-0dae09c444db95f79
      SLES12SP3SAPHVM: ami-0cef55a8a76f97f48
      SLES12SP4HVM: ami-05114ac18a716bc1c
      SLES12SP4SAPBYOSHVM: ami-028abd488e2c2f400
      SLES12SP4SAPHVM: ami-08ec16a7528db036b
      SLES12SP5HVM: ami-0a5e09b6782ac752d
      SLES12SP5SAPHVM: ami-05e237378438ccadd
      SLES12SP5SAPBYOSHVM: ami-0a16fdb6a898eabb8
      SLES15HVM: ami-0f81fff879bafe6b8
      SLES15SAPHVM: ami-025bc5b179c7689f8
      SLES15SAPBYOSHVM: ami-0cc04512ca5fb8d7c
      SLES15SP1HVM: ami-0bcca7befe1b4317b
      SLES15SP1SAPHVM: ami-0fa5c709ff8645343
      SLES15SP1SAPBYOSHVM: ami-0f590b27849da71ef
      SLES15SP2HVM: ami-00f6cd8265e8368cd
      SLES15SP2SAPHVM: ami-0145e667278ee4855
      SLES15SP2SAPBYOSHVM: ami-0b4249e5d5fa3c901
      SLES15SP3HVM: ami-044ecf95631bed563
      SLES15SP3SAPHVM: ami-00f4173a8c806321a
      SLES15SP3SAPBYOSHVM: ami-047a3249b2a1f6836
    ap-south-1:
      RHEL75SAPHVM: ami-0afdd099cb4cacadf
      RHEL74SAPHAUSHVM: ami-0167ffd4ebf2c034a
      RHEL75SAPHAUSHVM: ami-029b2a9859384e194
      RHEL76SAPHAUSHVM: ami-015afb3901ab40784
      RHEL77SAPHAUSHVM: ami-0bb6268c2b20bb790
      RHEL79SAPHAUSHVM: ami-0d81c43e1e1c52bc8
      RHEL81SAPHAUSHVM: ami-0b3a65db8ecfae24e
      RHEL82SAPHAUSHVM: ami-0e135fa7d43c1be40
      SLES11SP4HVM: ami-0bdb8670f707feabd
      SLES12SP1HVM: ami-985226f7
      SLES12SP1SAPBYOSHVM: ami-93c9bffc
      SLES12SP2HVM: ami-62e39c0d
      SLES12SP2SAPBYOSHVM: ami-074ee04de447633ed
      SLES12SP2SAPHVM: ami-0d596f0cc53977008
      SLES12SP3HVM: ami-0c1453eb750c7a5ab
      SLES12SP3SAPBYOSHVM: ami-00831fe0c42624267
      SLES12SP3SAPHVM: ami-01a3814eefe8a1697
      SLES12SP4HVM: ami-0e2520e97af25d4d2
      SLES12SP4SAPBYOSHVM: ami-05651b45e99d63d02
      SLES12SP4SAPHVM: ami-0e6f4e89109d8243d
      SLES12SP5HVM: ami-0d809080c3ef9dda5
      SLES12SP5SAPHVM: ami-01dbad3ed7db1157d
      SLES12SP5SAPBYOSHVM: ami-043dc53cb98cee1db
      SLES15HVM: ami-01be89269d32f2a16
      SLES15SAPHVM: ami-01a38e853e458e7e4
      SLES15SAPBYOSHVM: ami-0d5612595295301aa
      SLES15SP1HVM: ami-065edd4e2270fb2e1
      SLES15SP1SAPHVM: ami-0bf7149998ecf935d
      SLES15SP1SAPBYOSHVM: ami-017ca584131546f4b
      SLES15SP2HVM: ami-0d0522ed4db1debd6
      SLES15SP2SAPHVM: ami-02aec6ae8c51b76f8
      SLES15SP2SAPBYOSHVM: ami-05b36976822da904d
      SLES15SP3HVM: ami-0b5bb4464fa1bbac7
      SLES15SP3SAPHVM: ami-089c477f988e7486b
      SLES15SP3SAPBYOSHVM: ami-04cf78d71755e7b49
    ap-southeast-1:
      RHEL75SAPHVM: ami-08fc0673d9d83037a
      RHEL74SAPHAUSHVM: ami-037dc0ec600ed1888
      RHEL75SAPHAUSHVM: ami-05c8713dd14fa6156
      RHEL76SAPHAUSHVM: ami-0469d4463a41ed704
      RHEL77SAPHAUSHVM: ami-05f000547278b590b
      RHEL79SAPHAUSHVM: ami-0571742620b57cf87
      RHEL81SAPHAUSHVM: ami-077498966973e31a3
      RHEL82SAPHAUSHVM: ami-01b32ce8adba0294b
      SLES11SP4HVM: ami-021e49892145e1949
      SLES12SP1HVM: ami-163d9b75
      SLES12SP1SAPBYOSHVM: ami-ab0aa0c8
      SLES12SP2HVM: ami-f1078a92
      SLES12SP2SAPBYOSHVM: ami-0c5d434c11072f709
      SLES12SP2SAPHVM: ami-00a5e8e37caec221a
      SLES12SP3HVM: ami-06190570cf455031a
      SLES12SP3SAPBYOSHVM: ami-0a91084c1447100ed
      SLES12SP3SAPHVM: ami-048491051c0ad3dda
      SLES12SP4HVM: ami-05a7bd74a593452d7
      SLES12SP4SAPBYOSHVM: ami-07bae09461b7a3942
      SLES12SP4SAPHVM: ami-01fc893705c4e053e
      SLES12SP5HVM: ami-0cc1236e3867389b2
      SLES12SP5SAPHVM: ami-017d3ae7ad14f9270
      SLES12SP5SAPBYOSHVM: ami-0c805c27c1f65cb61
      SLES15HVM: ami-070356c21596ddc67
      SLES15SAPHVM: ami-0b312f69647b63e0e
      SLES15SAPBYOSHVM: ami-0701f0c9a5e645fe6
      SLES15SP1HVM: ami-0b7f7c934cfe30c63
      SLES15SP1SAPHVM: ami-02b65c7b1e10e1f36
      SLES15SP1SAPBYOSHVM: ami-0e60271c45271e4c5
      SLES15SP2HVM: ami-0d42c4e660c5c4135
      SLES15SP2SAPHVM: ami-0fe0150c8c547b441
      SLES15SP2SAPBYOSHVM: ami-029f6271399154e18
      SLES15SP3HVM: ami-00c5e4824e3f16564
      SLES15SP3SAPHVM: ami-01e7d9ecc1e382e8e
      SLES15SP3SAPBYOSHVM: ami-036b78cfa3627f029
    ap-southeast-2:
      RHEL75SAPHVM: ami-0a8af8e94f35319ba
      RHEL74SAPHAUSHVM: ami-0c5b5357081c68218
      RHEL75SAPHAUSHVM: ami-0df9dbd4828ca1166
      RHEL76SAPHAUSHVM: ami-0356eb53cb824dc7e
      RHEL77SAPHAUSHVM: ami-07140d1940650ab10
      RHEL79SAPHAUSHVM: ami-0ee58bbabebf8bc0d
      RHEL81SAPHAUSHVM: ami-05075c4ca95bb9f44
      RHEL82SAPHAUSHVM: ami-0bf9acbd8a1de517a
      SLES11SP4HVM: ami-0c966540b7cd84b4b
      SLES12SP1HVM: ami-e32b1680
      SLES12SP1SAPBYOSHVM: ami-460d0a25
      SLES12SP2HVM: ami-197a6a7a
      SLES12SP2SAPBYOSHVM: ami-0e9b31a7f29df983d
      SLES12SP2SAPHVM: ami-088ed61b6ad3a7a31
      SLES12SP3HVM: ami-0ccbc8eb74e84b8bd
      SLES12SP3SAPBYOSHVM: ami-0a22e7733b93a13cd
      SLES12SP3SAPHVM: ami-0f8fa01e74ddf4994
      SLES12SP4HVM: ami-0086939d81dda5418
      SLES12SP4SAPBYOSHVM: ami-0de01b6abc06547bb
      SLES12SP4SAPHVM: ami-09a3413dab4ad515e
      SLES12SP5HVM: ami-05a756a873b7a537c
      SLES12SP5SAPHVM: ami-0428ede8cab671bed
      SLES12SP5SAPBYOSHVM: ami-0a423a9c5e838c4e5
      SLES15HVM: ami-0c4245381c67efb39
      SLES15SAPHVM: ami-0c995271948cbb736
      SLES15SAPBYOSHVM: ami-0f5b781af42cbfa1e
      SLES15SP1HVM: ami-0d6f00758277a28f7
      SLES15SP1SAPHVM: ami-0e7675431bf1b7060
      SLES15SP1SAPBYOSHVM: ami-064ece640fbaacd64
      SLES15SP2HVM: ami-0948fed2b1645e486
      SLES15SP2SAPHVM: ami-0f620f93e3ba85cbb
      SLES15SP2SAPBYOSHVM: ami-0e3d98e82ffc6ba81
      SLES15SP3HVM: ami-0ab54bf17ea55362a
      SLES15SP3SAPHVM: ami-05401c688b551cf01
      SLES15SP3SAPBYOSHVM: ami-01342c2f2719fa356
    ca-central-1:
      RHEL75SAPHVM: ami-010ef109ec0f43d6d
      RHEL74SAPHAUSHVM: ami-06e94c1c4cd754fe5
      RHEL75SAPHAUSHVM: ami-0173442cbf82d3d9f
      RHEL76SAPHAUSHVM: ami-0c720e8ded4a6c5b0
      RHEL77SAPHAUSHVM: ami-0c873efb1ece4cef7
      RHEL79SAPHAUSHVM: ami-0cd2bc60a62d5aee6
      RHEL81SAPHAUSHVM: ami-062250ddecaa37cb8
      RHEL82SAPHAUSHVM: ami-01fde27426a9ff39b
      SLES11SP4HVM: ami-0a89186e8d2b82307
      SLES12SP1SAPBYOSHVM: ami-2fd4694b
      SLES12SP2HVM: ami-d5d56ab1
      SLES12SP2SAPBYOSHVM: ami-06c5c26336f743bf6
      SLES12SP2SAPHVM: ami-0b69394414a77d27d
      SLES12SP3HVM: ami-0f7c9a39e20a9adea
      SLES12SP3SAPBYOSHVM: ami-0bfb8d54b1407c64a
      SLES12SP3SAPHVM: ami-09e101dc35e3dd223
      SLES12SP4HVM: ami-00ff1fa0fb4b09437
      SLES12SP4SAPBYOSHVM: ami-07735575a65d9748f
      SLES12SP4SAPHVM: ami-0c1765e15fc9f78cc
      SLES12SP5HVM: ami-0a6ae1bd5ccd258ac
      SLES12SP5SAPHVM: ami-010d3ac6f6bf19a0f
      SLES12SP5SAPBYOSHVM: ami-0ace6ea96fdf61199
      SLES15HVM: ami-0c97d9b588207dad6
      SLES15SAPHVM: ami-07d033739f020a039
      SLES15SAPBYOSHVM: ami-08eec3db50798a295
      SLES15SP1HVM: ami-06ab9a53ab05446fa
      SLES15SP1SAPHVM: ami-0859859ca24c244d3
      SLES15SP1SAPBYOSHVM: ami-089a6dc2cfe68e618
      SLES15SP2HVM: ami-082b3eca746b12a89
      SLES15SP2SAPHVM: ami-03499dccef054a1dc
      SLES15SP2SAPBYOSHVM: ami-05b91d7d13240be05
      SLES15SP3HVM: ami-072cc113d8cb47344
      SLES15SP3SAPHVM: ami-0b5ae099dd3f69f8b
      SLES15SP3SAPBYOSHVM: ami-031122ade84827de2
    eu-central-1:
      RHEL75SAPHVM: ami-0841ec948df565271
      RHEL74SAPHAUSHVM: ami-0a38565bcb3243da0
      RHEL75SAPHAUSHVM: ami-08f1018e2a0f26daa
      RHEL76SAPHAUSHVM: ami-00e9db6661b279d3f
      RHEL77SAPHAUSHVM: ami-01dcf860794ebc023
      RHEL79SAPHAUSHVM: ami-00dced298e5d9fda4
      RHEL81SAPHAUSHVM: ami-07e149ef3fe651d94
      RHEL82SAPHAUSHVM: ami-063328327647c35c0
      SLES11SP4HVM: ami-0f032693ef4319469
      SLES12SP1HVM: ami-59699036
      SLES12SP1SAPBYOSHVM: ami-4b6ba424
      SLES12SP2HVM: ami-984ee9f7
      SLES12SP2SAPBYOSHVM: ami-07966002b34bab5f7
      SLES12SP2SAPHVM: ami-026230d85941a84a8
      SLES12SP3HVM: ami-0fa9bde3f3d40e5ae
      SLES12SP3SAPBYOSHVM: ami-088e91696b7dcd30c
      SLES12SP3SAPHVM: ami-0ab2953d28a3069fe
      SLES12SP4HVM: ami-00f695136e33f2fe0
      SLES12SP4SAPBYOSHVM: ami-0e6f5d8c7423fbf99
      SLES12SP4SAPHVM: ami-0ad0e6f64464f6714
      SLES12SP5HVM: ami-072821c76a98d748a
      SLES12SP5SAPHVM: ami-044c1a837095ba80c
      SLES12SP5SAPBYOSHVM: ami-065c2a26d028f22e0
      SLES15HVM: ami-05dfd265ea534a3e9
      SLES15SAPHVM: ami-0823a4f2cd6f5ff6c
      SLES15SAPBYOSHVM: ami-0c3196786bb2ef35a
      SLES15SP1HVM: ami-0c99be8a286251d31
      SLES15SP1SAPHVM: ami-01b462b77531c0987
      SLES15SP1SAPBYOSHVM: ami-027b3d89ee49978c6
      SLES15SP2HVM: ami-0ed0be684d3f014bf
      SLES15SP2SAPHVM: ami-0e3086eb56a7aaf20
      SLES15SP2SAPBYOSHVM: ami-05e0d6324cbacfb0c
      SLES15SP3HVM: ami-0f41f631f29c789c5
      SLES15SP3SAPHVM: ami-09f79cba482b5aaa9
      SLES15SP3SAPBYOSHVM: ami-0a0f13d2f1a4e5215
    eu-west-1:
      RHEL75SAPHVM: ami-04a014a7d626b3fd8
      RHEL74SAPHAUSHVM: ami-0af3e97778546f34b
      RHEL75SAPHAUSHVM: ami-0dfa47f27b3bf9922
      RHEL76SAPHAUSHVM: ami-0e39a11a4694e879d
      RHEL77SAPHAUSHVM: ami-038297ef05af48e93
      RHEL79SAPHAUSHVM: ami-0f0692db9802d4927
      RHEL81SAPHAUSHVM: ami-015f69b4005371d84
      RHEL82SAPHAUSHVM: ami-018d53d62551b1189
      SLES11SP4HVM: ami-0a40ff0e3202c10e1
      SLES12SP1HVM: ami-b197d9c2
      SLES12SP1SAPBYOSHVM: ami-81025de7
      SLES12SP2HVM: ami-f5776f93
      SLES12SP2SAPBYOSHVM: ami-083a4aebd9d24276c
      SLES12SP2SAPHVM: ami-07cd573b3c20fdc08
      SLES12SP3HVM: ami-06bc7889ee68f279e
      SLES12SP3SAPBYOSHVM: ami-0461814360323e368
      SLES12SP3SAPHVM: ami-04d42962dc1318ffa
      SLES12SP4HVM: ami-0b27edba737a4a44a
      SLES12SP4SAPBYOSHVM: ami-0a850f691a934ad5e
      SLES12SP4SAPHVM: ami-0fd5f466cb98894a7
      SLES12SP5HVM: ami-0d34987ebe4d9338c
      SLES12SP5SAPHVM: ami-0c58c824ffa44e4f9
      SLES12SP5SAPBYOSHVM: ami-076c2a24f542345e6      
      SLES15HVM: ami-0a58a1b152ba55f1d
      SLES15SAPHVM: ami-0fda5e832418d2123
      SLES15SAPBYOSHVM: ami-032a80d78e21d81a3
      SLES15SP1HVM: ami-0c7c799aac480ea77
      SLES15SP1SAPHVM: ami-017324f2c7211b9e2
      SLES15SP1SAPBYOSHVM: ami-017953df5fa38a769
      SLES15SP2HVM: ami-051cbea0e7660063d
      SLES15SP2SAPHVM: ami-0fe36be1be2a3646c
      SLES15SP2SAPBYOSHVM: ami-0e849c2f8190302a2
      SLES15SP3HVM: ami-07002a251775537ae
      SLES15SP3SAPHVM: ami-01f37012fe989aeda
      SLES15SP3SAPBYOSHVM: ami-07dd91577aaae0cf1
    eu-west-2:
      RHEL75SAPHVM: ami-070b8ef548695f653
      RHEL74SAPHAUSHVM: ami-005b4b0f0decc3229
      RHEL75SAPHAUSHVM: ami-0d24c16fec55a94f4
      RHEL76SAPHAUSHVM: ami-0aeabd574eb91aa0b
      RHEL77SAPHAUSHVM: ami-0b07133ce7258f364
      RHEL79SAPHAUSHVM: ami-00a34f237162f1bad
      RHEL81SAPHAUSHVM: ami-022ee66b4570dcb25
      RHEL82SAPHAUSHVM: ami-0aa3d65403597d1a9
      SLES11SP4HVM: ami-06a87787f9466fa7b
      SLES12SP1SAPBYOSHVM: ami-b2a1abd6
      SLES12SP2HVM: ami-d97066bd
      SLES12SP2SAPBYOSHVM: ami-0e77c12686f306f46
      SLES12SP2SAPHVM: ami-05efc0a082a46f7e1
      SLES12SP3HVM: ami-0eb4bd78fba2f32e4
      SLES12SP3SAPBYOSHVM: ami-04e2fe477c0a1411f
      SLES12SP3SAPHVM: ami-0dd1a88871a7960fa
      SLES12SP4HVM: ami-01016d5a2f759e80e
      SLES12SP4SAPBYOSHVM: ami-0ac859e29f5094204
      SLES12SP4SAPHVM: ami-0ff4cabd1259cddfd
      SLES12SP5HVM: ami-0b2c68aa6deafd9ec
      SLES12SP5SAPHVM: ami-0b1b77dd8dd41fda7
      SLES12SP5SAPBYOSHVM: ami-084e1e5e22e50521b
      SLES15HVM: ami-01497522185aaa4ee
      SLES15SAPHVM: ami-060b2e1e236b73f00
      SLES15SAPBYOSHVM: ami-06f2df89214f6ead9
      SLES15SP1HVM: ami-01f3fa4b1427a8522
      SLES15SP1SAPHVM: ami-09dc593a5b487dcac
      SLES15SP1SAPBYOSHVM: ami-08a6a902319ad3554
      SLES15SP2HVM: ami-0b1feeb6a46bffd83
      SLES15SP2SAPHVM: ami-0ee45f3b2a760e62c
      SLES15SP2SAPBYOSHVM: ami-051e16bbbce19d15c
      SLES15SP3HVM: ami-0625e138c60259089
      SLES15SP3SAPHVM: ami-067165d348fe49049
      SLES15SP3SAPBYOSHVM: ami-0ab6f082cff730397
    eu-west-3:
      RHEL75SAPHVM: ami-0b9d6c1ae0e94e8a9
      RHEL74SAPHAUSHVM: ami-01f114d111cc45831
      RHEL75SAPHAUSHVM: ami-0d0e00736cd23369b
      RHEL76SAPHAUSHVM: ami-0c1cf4ecf66e353e8
      RHEL77SAPHAUSHVM: ami-0c52a21aae5956c1f
      RHEL79SAPHAUSHVM: ami-0869c771789463d7f
      RHEL81SAPHAUSHVM: ami-0ffe075f8b5559394
      RHEL82SAPHAUSHVM: ami-04c50a2fdd0eb8448
      SLES11SP4HVM: ami-036671c4b09355867
      SLES12SP1SAPBYOSHVM: ami-cf992eb2
      SLES12SP2SAPBYOSHVM: ami-0664ede0d13c0c473
      SLES12SP2SAPHVM: ami-051cfee36f46b2f73
      SLES12SP3HVM: ami-07b20332d54ed21e8
      SLES12SP3SAPBYOSHVM: ami-033b4942a6ba88005
      SLES12SP3SAPHVM: ami-01cbec7515c17c466
      SLES12SP4HVM: ami-077db4bb21fe102b3
      SLES12SP4SAPBYOSHVM: ami-0c63b2bb6afc549b4
      SLES12SP4SAPHVM: ami-0a004ab2ecfdfb1bc
      SLES12SP5HVM: ami-04bd6584a0047f478
      SLES12SP5SAPHVM: ami-01050f872bc27e2b6
      SLES12SP5SAPBYOSHVM: ami-070e7f0d6a08ef9cc
      SLES15HVM: ami-0f238bd4c6fdbefb0
      SLES15SAPHVM: ami-0a10a689c47a8a6af
      SLES15SAPBYOSHVM: ami-0f842e919e4e4eb6a
      SLES15SP1HVM: ami-04451e7a9fa8ac139
      SLES15SP1SAPHVM: ami-0e9fe8488f9dd3f83
      SLES15SP1SAPBYOSHVM: ami-02dfcee559c90116e
      SLES15SP2HVM: ami-0801518334fb27b99
      SLES15SP2SAPHVM: ami-0770b81da7ef04555
      SLES15SP2SAPBYOSHVM: ami-01b5258ea6299fbc2
      SLES15SP3HVM: ami-0930d3e276f9f55dc
      SLES15SP3SAPHVM: ami-07aa7cbf2212c655e
      SLES15SP3SAPBYOSHVM: ami-0fb9825cce677c1e2
    sa-east-1:
      RHEL75SAPHVM: ami-0a9ee704defec0845
      RHEL74SAPHAUSHVM: ami-04450cf66c6bf5f42
      RHEL75SAPHAUSHVM: ami-0fb635cae4f8c6028
      RHEL76SAPHAUSHVM: ami-0c60751a062c4295b
      RHEL77SAPHAUSHVM: ami-05d4e72d16ab78f8c
      RHEL79SAPHAUSHVM: ami-039dcf43b54cd1648
      RHEL81SAPHAUSHVM: ami-04e54f361dd41dc02
      RHEL82SAPHAUSHVM: ami-0acaae8027a7377df
      SLES11SP4HVM: ami-00134f83806a20f4a
      SLES12SP1HVM: ami-ce3aa7a2
      SLES12SP1SAPBYOSHVM: ami-eb543187
      SLES12SP2HVM: ami-52a4cf3e
      SLES12SP2SAPBYOSHVM: ami-046181f67382fdd53
      SLES12SP2SAPHVM: ami-09d9d6c5c06d8a320
      SLES12SP3HVM: ami-0188b2a9dc0ae5f44
      SLES12SP3SAPBYOSHVM: ami-0ec3fee2bd8133f91
      SLES12SP3SAPHVM: ami-020ab250cd2edee07
      SLES12SP4HVM: ami-022eaa5bbc1e2f47a
      SLES12SP4SAPBYOSHVM: ami-0451db96691925d3b
      SLES12SP4SAPHVM: ami-0137ba6d20f42569d
      SLES12SP5HVM: ami-0b8d9a20d96664d17
      SLES12SP5SAPHVM: ami-0936d0a1adb5d786b
      SLES12SP5SAPBYOSHVM: ami-042276164a8c8400f
      SLES15HVM: ami-0772af912976aa692
      SLES15SAPHVM: ami-0867633aaf95b8b45
      SLES15SAPBYOSHVM: ami-0a374c04d3223b56d
      SLES15SP1HVM: ami-0d760167d68cf77ba
      SLES15SP1SAPHVM: ami-036a793b58bf4fc45
      SLES15SP1SAPBYOSHVM: ami-05054daf44015504d
      SLES15SP2HVM: ami-077e4fba84052c862
      SLES15SP2SAPHVM: ami-0f73b6642241ea2e2
      SLES15SP2SAPBYOSHVM: ami-044437a7d786094c3
      SLES15SP3HVM: ami-075578324c475370a
      SLES15SP3SAPHVM: ami-00000ca78c8bd9e23
      SLES15SP3SAPBYOSHVM: ami-022b657f7617d5143
    us-east-1:
      RHEL75SAPHVM: ami-05cd8f1730c8df7dc
      RHEL74SAPHAUSHVM: ami-0f458a41a777ef497
      RHEL75SAPHAUSHVM: ami-0d81d8964ccf8bdef
      RHEL76SAPHAUSHVM: ami-054a9dc6c144331a0
      RHEL77SAPHAUSHVM: ami-02ab9781e398586fb
      RHEL79SAPHAUSHVM: ami-03d4a06080d3d57e0
      RHEL81SAPHAUSHVM: ami-06188bf1c22578712 
      RHEL82SAPHAUSHVM: ami-0e459d519030c2bd7
      SLES11SP4HVM: ami-05b47745292b62b8e
      SLES12SP1HVM: ami-1eeab909
      SLES12SP1SAPBYOSHVM: ami-7dd2256b
      SLES12SP2HVM: ami-8fac8399
      SLES12SP2SAPBYOSHVM: ami-006668674e5150470
      SLES12SP2SAPHVM: ami-03032964354d05e9c
      SLES12SP3HVM: ami-03adb8813ffd80f0b
      SLES12SP3SAPBYOSHVM: ami-09e515a2f58fc7a93
      SLES12SP3SAPHVM: ami-03f4b359c63c12d83
      SLES12SP4HVM: ami-0787571b4033204ad
      SLES12SP4SAPBYOSHVM: ami-0f9b20b9789585aa4
      SLES12SP4SAPHVM: ami-057832816bd4496b3
      SLES12SP5HVM: ami-01c56f7583006a128
      SLES12SP5SAPHVM: ami-060591f82d1d72b56
      SLES12SP5SAPBYOSHVM: ami-0cf0aefaf862fe6ec
      SLES15HVM: ami-0b1764f3d7d2e2316
      SLES15SAPHVM: ami-034a4657781cac699
      SLES15SAPBYOSHVM: ami-0b335002243e5a9ff
      SLES15SP1HVM: ami-0b326695e023b93d5
      SLES15SP1SAPHVM: ami-0f573d7473ead14cb
      SLES15SP1SAPBYOSHVM: ami-02441223112f6ae2a
      SLES15SP2HVM: ami-0a782e324655d1cc0
      SLES15SP2SAPHVM: ami-05945a229301948bc
      SLES15SP2SAPBYOSHVM: ami-04a3953051021dd17
      SLES15SP3HVM: ami-06472bdef515145b9
      SLES15SP3SAPHVM: ami-0ea925a9c280993aa
      SLES15SP3SAPBYOSHVM: ami-0dcca7e66278164ed
    us-east-2:
      RHEL75SAPHVM: ami-0b1439383ea0d0c87
      RHEL74SAPHAUSHVM: ami-0cfab53d572d62388
      RHEL75SAPHAUSHVM: ami-03527d73c82921684
      RHEL76SAPHAUSHVM: ami-02bf9176554430b2a
      RHEL77SAPHAUSHVM: ami-0e1e265454ad74262
      RHEL79SAPHAUSHVM: ami-0327adbb3331c5c02
      RHEL81SAPHAUSHVM: ami-0bd293a1024b1da3d
      RHEL82SAPHAUSHVM: ami-00eb484d1be56e0b0
      SLES11SP4HVM: ami-0d984fc673fefcb8c
      SLES12SP1HVM: ami-85075de0
      SLES12SP1SAPBYOSHVM: ami-ac2401c9
      SLES12SP2HVM: ami-f990b69c
      SLES12SP2SAPBYOSHVM: ami-0312e837f2f3e7ed3
      SLES12SP2SAPHVM: ami-062d128e25a4979c2
      SLES12SP3HVM: ami-0479b39f2d07530fb
      SLES12SP3SAPBYOSHVM: ami-03dcbd3a0a73c3e1c
      SLES12SP3SAPHVM: ami-077daf5b4eb744e5c
      SLES12SP4HVM: ami-0f24364ccc4040c21
      SLES12SP4SAPBYOSHVM: ami-0b4e01a990b03a9ae
      SLES12SP4SAPHVM: ami-0458e523e4d3498f8
      SLES12SP5HVM: ami-0f84a134e8f9d527b
      SLES12SP5SAPHVM: ami-060a75c15e9a00f12
      SLES12SP5SAPBYOSHVM: ami-0a65b6c15a3772fe6
      SLES15HVM: ami-05ea824317ffc0c20
      SLES15SAPHVM: ami-0ad6708faee9090ba
      SLES15SAPBYOSHVM: ami-00ee7014fa39c34cd
      SLES15SP1HVM: ami-0efc9a15a1fd61f97
      SLES15SP1SAPHVM: ami-0ac9e1036afa81c8f
      SLES15SP1SAPBYOSHVM: ami-017f2c9934036a1c1
      SLES15SP2HVM: ami-03f4c416f489586a3
      SLES15SP2SAPHVM: ami-0ee100ff9112496d5
      SLES15SP2SAPBYOSHVM: ami-
      SLES15SP3HVM: ami-055742ec92937ec3e
      SLES15SP3SAPHVM: ami-04c00493af1f923d5
      SLES15SP3SAPBYOSHVM: ami-0043026d49177fd5d
    us-west-1:
      RHEL75SAPHVM: ami-015c680b92b8f8e04
      RHEL74SAPHAUSHVM: ami-0bce690da8c3f9573
      RHEL75SAPHAUSHVM: ami-09294cb9917bcb535
      RHEL76SAPHAUSHVM: ami-05163897ae5e64145
      RHEL77SAPHAUSHVM: ami-0e262ec2b13510660
      RHEL79SAPHAUSHVM: ami-00de2095409dec191
      RHEL81SAPHAUSHVM: ami-0aaac6f5226d9b03d
      RHEL82SAPHAUSHVM: ami-0c64e518c8ea61e9f
      SLES11SP4HVM: ami-07db9616cb48eef6e
      SLES12SP1HVM: ami-a12962c1
      SLES12SP1SAPBYOSHVM: ami-4a9dcf2a
      SLES12SP2HVM: ami-32c8e552
      SLES12SP2SAPBYOSHVM: ami-039ae8bf416dc3bde
      SLES12SP2SAPHVM: ami-01617594940e3550e
      SLES12SP3HVM: ami-05561250b8346a707
      SLES12SP3SAPBYOSHVM: ami-0f7b3754a9689ddfa
      SLES12SP3SAPHVM: ami-0095e76cf1280c061
      SLES12SP4HVM: ami-0afb3187a37661b18
      SLES12SP4SAPBYOSHVM: ami-04e84846cf5b2eceb
      SLES12SP4SAPHVM: ami-0d51a3027d6c22a27
      SLES12SP5HVM: ami-0bbad4c23091f92c2
      SLES12SP5SAPHVM: ami-08b5654aeff747ab4
      SLES12SP5SAPBYOSHVM: ami-0f5f3c7b6f1539680
      SLES15HVM: ami-00e34a7624e5a7107
      SLES15SAPHVM: ami-0867f45fee8435a19
      SLES15SAPBYOSHVM: ami-039fb1d14e2287565
      SLES15SP1HVM: ami-03e34490092993986
      SLES15SP1SAPHVM: ami-008f4b7a6fa1b739a
      SLES15SP1SAPBYOSHVM: ami-03d16b4fbe4d9898a
      SLES15SP2HVM: ami-0ac3dbf3917611d92
      SLES15SP2SAPHVM: ami-04d5e5533369cefce
      SLES15SP2SAPBYOSHVM: ami-0bbbc4bb8cfe16e58
      SLES15SP3HVM: ami-03267cc539472b721
      SLES15SP3SAPHVM: ami-064bd64813afd20b7
      SLES15SP3SAPBYOSHVM: ami-0dd8c14b70c709ed1
    us-west-2:
      RHEL75SAPHVM: ami-07894ab0a4a5e8612
      RHEL74SAPHAUSHVM: ami-050890ecc1851620c
      RHEL75SAPHAUSHVM: ami-07f49a6a84d94211e
      RHEL76SAPHAUSHVM: ami-0062814abe5ca3369
      RHEL77SAPHAUSHVM: ami-0b510971b60b0a6d0
      RHEL79SAPHAUSHVM: ami-0feba30a9160fc51a
      RHEL81SAPHAUSHVM: ami-03e4a43b8037551d5
      RHEL82SAPHAUSHVM: ami-0c914c77dfd5884d9
      SLES11SP4HVM: ami-09a652af9ed1e0dad
      SLES12SP1HVM: ami-7fa2061f
      SLES12SP1SAPBYOSHVM: ami-68922c08
      SLES12SP2HVM: ami-da786da3
      SLES12SP2SAPBYOSHVM: ami-057a6cd34fc874a04
      SLES12SP2SAPHVM: ami-0e81e312127e49ae0
      SLES12SP3HVM: ami-015ee9a0398544b09
      SLES12SP3SAPBYOSHVM: ami-02df08fd0856d266b
      SLES12SP3SAPHVM: ami-093d9dce64af94d34
      SLES12SP4HVM: ami-0a3c873f21d686544
      SLES12SP4SAPBYOSHVM: ami-042663489704d9c3f
      SLES12SP4SAPHVM: ami-0d28ddb801d9589f0
      SLES12SP5HVM: ami-088a78f435ef7f78a
      SLES12SP5SAPHVM: ami-09ba150453de3da6e
      SLES12SP5SAPBYOSHVM: ami-041ee54df25d7acc4
      SLES15HVM: ami-0f1e3b3fb0fec0361
      SLES15SAPHVM: ami-0ca00995da6bbdea0
      SLES15SAPBYOSHVM: ami-08c05da8c43e5091a
      SLES15SP1HVM: ami-0ccefbfd6cd77b0a2
      SLES15SP1SAPHVM: ami-03f140f3bd4d8fd84
      SLES15SP1SAPBYOSHVM: ami-0f13e69c5ded1ffdf
      SLES15SP2HVM: ami-063c2d222d223d0e9
      SLES15SP2SAPHVM: ami-0d1c9c993b409763e
      SLES15SP2SAPBYOSHVM: ami-0c71da127ffc25496
      SLES15SP3HVM: ami-0631da5c6a54d5123
      SLES15SP3SAPHVM: ami-0c788f4b321f82d69
      SLES15SP3SAPBYOSHVM: ami-01589645ded2e0969
Outputs:
  HANAMasterInstanceIP:
    Description: HANA Master Node IP Address
    Value: !GetAtt 'HANAMasterInstance.PrivateIp'
  HANAMasterSecurityGroup:
    Description: Security Group created for the SAP HANA Master node
    Value: !GetAtt 'HANASecurityGroup.GroupId'
  HANAMasterInstanceRole:
    Description: Instance Role Name for HANA Instance
    Value: !Ref 'HANAIAMRole'
  HANAMasterInstanceId:
    Description: Instance Id for HANA Instance
    Value: !Ref 'HANAMasterInstance'
Resources:
  Trail:
    DependsOn:
      - BucketPolicy
    Type: AWS::CloudTrail::Trail
    Condition: IfLogging
    Properties:
      IncludeGlobalServiceEvents: true
      S3BucketName: !Ref 'CloudTrailS3Bucket'
      SnsTopicName: !Ref 'AWS::NoValue'
      IsLogging: true
  BucketPolicy:
    Type: AWS::S3::BucketPolicy
    Condition: IfLogging
    Properties:
      Bucket: !Ref 'CloudTrailS3Bucket'
      PolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Sid: AWSCloudTrailAclCheck20150319
            Effect: Allow
            Principal:
              Service: cloudtrail.amazonaws.com
            Action: s3:GetBucketAcl
            Resource: !Join
              - ''
              - - 'arn:aws:s3:::'
                - !Ref 'CloudTrailS3Bucket'
          - Sid: AWSCloudTrailWrite20150319
            Effect: Allow
            Principal:
              Service: cloudtrail.amazonaws.com
            Action: s3:PutObject
            Resource: !Join
              - ''
              - - 'arn:aws:s3:::'
                - !Ref 'CloudTrailS3Bucket'
                - /AWSLogs/
                - !Ref 'AWS::AccountId'
                - /*
            Condition:
              StringEquals:
                s3:x-amz-acl: bucket-owner-full-control
          - Sid: AWSConfigBucketPermissionsCheck
            Effect: Allow
            Principal:
              Service:
                - config.amazonaws.com
            Action: s3:GetBucketAcl
            Resource: !Join
              - ''
              - - 'arn:aws:s3:::'
                - !Ref 'CloudTrailS3Bucket'
          - Sid: ' AWSConfigBucketDelivery'
            Effect: Allow
            Principal:
              Service:
                - config.amazonaws.com
            Action: s3:PutObject
            Resource: !Join
              - ''
              - - 'arn:aws:s3:::'
                - !Ref 'CloudTrailS3Bucket'
                - /AWSLogs/
                - !Ref 'AWS::AccountId'
                - /Config/*
            Condition:
              StringEquals:
                s3:x-amz-acl: bucket-owner-full-control
  ConfigRecorder:
    DependsOn:
      - AWSConfigIAMRole
    Type: AWS::Config::ConfigurationRecorder
    Condition: IfLogging
    Properties:
      Name: HANAQuickStart-ConfigRecord
      RecordingGroup:
        ResourceTypes:
          - AWS::S3::Bucket
          - AWS::CloudTrail::Trail
          - AWS::EC2::Instance
          - AWS::EC2::SecurityGroup
          - AWS::EC2::NetworkInterface
          - AWS::EC2::Volume
          - AWS::EC2::VPC
          - AWS::EC2::Subnet
          - AWS::EC2::RouteTable
          - AWS::EC2::NetworkAcl
      RoleARN: !GetAtt 'AWSConfigIAMRole.Arn'
  DeliveryChannel:
    Type: AWS::Config::DeliveryChannel
    Condition: IfLogging
    Properties:
      ConfigSnapshotDeliveryProperties:
        DeliveryFrequency: One_Hour
      S3BucketName: !Ref 'CloudTrailS3Bucket'
  AWSConfigIAMRole:
    Type: AWS::IAM::Role
    Condition: IfLogging
    Properties:
      Path: /
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/service-role/AWSConfigRole
      AssumeRolePolicyDocument:
        Statement:
          - Effect: Allow
            Principal:
              Service:
                - config.amazonaws.com
            Action:
              - sts:AssumeRole
  DeploymentInterruptQ:
    Type: AWS::SQS::Queue
    Properties:
      DelaySeconds: 0
      VisibilityTimeout: 0
  HANASecretManager:
    Type: AWS::SecretsManager::Secret
    Properties:
      Name: !Ref 'AWS::StackName'
      Description: 'SAP HANA QuickStart SecretsManager Password'
      SecretString: !Ref 'HANAMasterPass'
  HANAMasterInterface:
    Type: AWS::EC2::NetworkInterface
    Properties:
      Description: Network Interface for HANA Master
      SubnetId: !Ref 'HANASubnet'
      GroupSet:
        - !Ref 'HANASecurityGroup'
      SourceDestCheck: true
      Tags:
        - Key: Network
          Value: Private
  HANAWorker1Interface:
    Type: AWS::EC2::NetworkInterface
    Condition: TwoOrMoreNodes
    Properties:
      SubnetId: !Ref 'HANASubnet'
      Description: Interface for HANA Worker 1
      GroupSet:
        - !Ref 'HANASlaveSG'
      SourceDestCheck: true
      Tags:
        - Key: Network
          Value: Private
  HANAWorker2Interface:
    Type: AWS::EC2::NetworkInterface
    Condition: ThreeOrMoreNodes
    Properties:
      SubnetId: !Ref 'HANASubnet'
      Description: Interface for HANA Worker 2
      GroupSet:
        - !Ref 'HANASlaveSG'
      SourceDestCheck: true
      Tags:
        - Key: Network
          Value: Private
  HANAWorker3Interface:
    Type: AWS::EC2::NetworkInterface
    Condition: FourOrMoreNodes
    Properties:
      SubnetId: !Ref 'HANASubnet'
      Description: Interface for HANA Worker 3
      GroupSet:
        - !Ref 'HANASlaveSG'
      SourceDestCheck: true
      Tags:
        - Key: Network
          Value: Private
  HANAWorker4Interface:
    Type: AWS::EC2::NetworkInterface
    Condition: FiveOrMoreNodes
    Properties:
      SubnetId: !Ref 'HANASubnet'
      Description: Interface for HANA Worker 4
      GroupSet:
        - !Ref 'HANASlaveSG'
      SourceDestCheck: true
      Tags:
        - Key: Network
          Value: Private
  HANAWorker5Interface:
    Type: AWS::EC2::NetworkInterface
    Condition: SixOrMoreNodes
    Properties:
      SubnetId: !Ref 'HANASubnet'
      Description: Interface for HANA Worker 5
      GroupSet:
        - !Ref 'HANASlaveSG'
      SourceDestCheck: true
      Tags:
        - Key: Network
          Value: Private
  HANASecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupDescription: Enable external access to the HANA Master and allow communication
        from slave instances
      VpcId: !Ref 'VPCID'
      SecurityGroupIngress:
        - IpProtocol: tcp
          CidrIp: !Ref 'PrivSubCIDR'
          FromPort: 1
          ToPort: 65535
        - IpProtocol: udp
          CidrIp: !Ref 'PrivSubCIDR'
          FromPort: 111
          ToPort: 111
        - IpProtocol: udp
          CidrIp: !Ref 'PrivSubCIDR'
          FromPort: 2049
          ToPort: 2049
        - IpProtocol: tcp
          CidrIp: !Ref 'PrivSubCIDR'
          FromPort: 2049
          ToPort: 2049
        - IpProtocol: udp
          CidrIp: !Ref 'PrivSubCIDR'
          FromPort: 4000
          ToPort: 4002
        - IpProtocol: icmp
          CidrIp: !Ref 'PrivSubCIDR'
          FromPort: -1
          ToPort: -1
        - IpProtocol: tcp
          CidrIp: !Ref 'DMZCIDR'
          FromPort: !Join
            - ''
            - - '5'
              - !Ref 'SAPInstanceNum'
              - '13'
          ToPort: !Join
            - ''
            - - '5'
              - !Ref 'SAPInstanceNum'
              - '14'
        - IpProtocol: tcp
          CidrIp: !Ref 'DMZCIDR'
          FromPort: !Join
            - ''
            - - '3'
              - !Ref 'SAPInstanceNum'
              - '13'
          ToPort: !Join
            - ''
            - - '3'
              - !Ref 'SAPInstanceNum'
              - '13'
        - IpProtocol: tcp
          CidrIp: !Ref 'DMZCIDR'
          FromPort: !Join
            - ''
            - - '3'
              - !Ref 'SAPInstanceNum'
              - '15'
          ToPort: !Join
            - ''
            - - '3'
              - !Ref 'SAPInstanceNum'
              - '15'
        - IpProtocol: tcp
          CidrIp: !Ref 'DMZCIDR'
          FromPort: !Join
            - ''
            - - '3'
              - !Ref 'SAPInstanceNum'
              - '17'
          ToPort: !Join
            - ''
            - - '3'
              - !Ref 'SAPInstanceNum'
              - '17'
        - IpProtocol: tcp
          CidrIp: !Ref 'DMZCIDR'
          FromPort: !Join
            - ''
            - - '3'
              - !Ref 'SAPInstanceNum'
              - '41'
          ToPort: !Join
            - ''
            - - '3'
              - !Ref 'SAPInstanceNum'
              - '44'
        - IpProtocol: tcp
          CidrIp: !Ref 'DMZCIDR'
          FromPort: !Join
            - ''
            - - '80'
              - !Ref 'SAPInstanceNum'
              - ''
          ToPort: !Join
            - ''
            - - '80'
              - !Ref 'SAPInstanceNum'
              - ''
        - IpProtocol: tcp
          CidrIp: !Ref 'DMZCIDR'
          FromPort: !Join
            - ''
            - - '3'
              - !Ref 'SAPInstanceNum'
              - '09'
          ToPort: !Join
            - ''
            - - '3'
              - !Ref 'SAPInstanceNum'
              - '09'
        - IpProtocol: tcp
          CidrIp: !Ref 'DMZCIDR'
          FromPort: !Join
            - ''
            - - '43'
              - !Ref 'SAPInstanceNum'
              - ''
          ToPort: !Join
            - ''
            - - '43'
              - !Ref 'SAPInstanceNum'
              - ''
        - IpProtocol: tcp
          CidrIp: !Ref 'DMZCIDR'
          FromPort: 8080
          ToPort: 8080
        - IpProtocol: tcp
          CidrIp: !Ref 'DMZCIDR'
          FromPort: 8443
          ToPort: 8443
        - IpProtocol: tcp
          CidrIp: !Ref 'DMZCIDR'
          FromPort: 1128
          ToPort: 1128
        - IpProtocol: tcp
          CidrIp: !Ref 'DMZCIDR'
          FromPort: 1129
          ToPort: 1129
        - IpProtocol: tcp
          CidrIp: !Ref 'DMZCIDR'
          FromPort: 22
          ToPort: 22
      SecurityGroupEgress:
        - IpProtocol: '-1'
          CidrIp: '0.0.0.0/0'
          FromPort: 1
          ToPort: 65535
  HANASecurityGroupUpdate:
    Type: AWS::EC2::SecurityGroupIngress
    Condition: IfAppSubnet
    Properties:
      CidrIp: !Ref 'ApplicationCIDR'
      Description: SAP Client Traffic
      IpProtocol: tcp
      FromPort: !Join
        - ''
        - - '3'
          - !Ref 'SAPInstanceNum'
          - '13'
      ToPort: !Join
        - ''
        - - '3'
          - !Ref 'SAPInstanceNum'
          - '17'
      GroupId: !Ref 'HANASecurityGroup'
  HANASlaveSG:
    Type: AWS::EC2::SecurityGroup
    Condition: TwoOrMoreNodes
    Properties:
      GroupDescription: Enable communication between the master and slave instances
      VpcId: !Ref 'VPCID'
      SecurityGroupIngress:
        - IpProtocol: tcp
          FromPort: 1
          ToPort: 65535
          CidrIp: !Ref 'PrivSubCIDR'
        - IpProtocol: tcp
          FromPort: !Join
            - ''
            - - '5'
              - !Ref 'SAPInstanceNum'
              - '13'
          ToPort: !Join
            - ''
            - - '5'
              - !Ref 'SAPInstanceNum'
              - '14'
          CidrIp: !Ref 'DMZCIDR'
        - IpProtocol: tcp
          FromPort: !Join
            - ''
            - - '3'
              - !Ref 'SAPInstanceNum'
              - '15'
          ToPort: !Join
            - ''
            - - '3'
              - !Ref 'SAPInstanceNum'
              - '15'
          CidrIp: !Ref 'DMZCIDR'
        - IpProtocol: tcp
          FromPort: !Join
            - ''
            - - '3'
              - !Ref 'SAPInstanceNum'
              - '17'
          ToPort: !Join
            - ''
            - - '3'
              - !Ref 'SAPInstanceNum'
              - '17'
          CidrIp: !Ref 'DMZCIDR'
        - IpProtocol: tcp
          FromPort: 1128
          ToPort: 1129
          CidrIp: !Ref 'DMZCIDR'
        - IpProtocol: tcp
          FromPort: 8080
          ToPort: 8080
          CidrIp: !Ref 'DMZCIDR'
        - IpProtocol: tcp
          FromPort: 8443
          ToPort: 8443
          CidrIp: !Ref 'DMZCIDR'
        - IpProtocol: tcp
          FromPort: 22
          ToPort: 22
          CidrIp: !Ref 'DMZCIDR'
      SecurityGroupEgress:
        - IpProtocol: '-1'
          FromPort: 1
          ToPort: 65535
          CidrIp: '0.0.0.0/0'
  HANAIAMRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Statement:
          - Effect: Allow
            Principal:
              Service:
                - ec2.amazonaws.com
                - ssm.amazonaws.com
            Action:
              - sts:AssumeRole
      Path: /
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/service-role/AmazonEC2RoleforSSM
      Policies:
        - PolicyName: HANA-QuickStart
          PolicyDocument:
            Statement:
              - Effect: Allow
                Action:
                  - s3:GetObject
                  - s3:ListBucket
                  - s3:GetBucketLocation
                Resource: !Join
                  - ''
                  - - "arn:aws:s3:::"
                    - !Select
                      - "2"
                      - !Split
                        - "/"
                        - !Ref "HANAInstallMedia"
              
              - Effect: Allow
                Action: ec2:ModifyInstanceAttribute
                Resource: "arn:aws:ec2:*:*:instance/*"
                Condition:
                  StringEquals: 
                    "ec2:ResourceTag/aws:cloudformation:stack-name": !Ref AWS::StackName
              
              - Effect: Allow
                Action: ec2:CreateTags
                Resource: 
                  - "arn:aws:ec2:*:*:volume/*"
                  - "arn:aws:ec2:*:*:instance/*"

              - Effect: Allow
                Action: ec2:AttachVolume
                Resource:
                  - "arn:aws:ec2:*:*:volume/*"
                  - "arn:aws:ec2:*:*:instance/*"
                Condition:
                  StringLike: 
                    "ec2:ResourceTag/SAPHANAQuickStart": !Ref AWS::StackId

              - Effect: Allow
                Action: ec2:CreateVolume
                Resource: "*"
                Condition:
                  ForAllValues:StringEquals: 
                    "aws:TagKeys": "SAPHANAQuickStart"
                    
              - Effect: Allow
                Action:
                  - ec2:DescribeVolumes
                  - ec2:DescribeVolumeStatus
                  - ec2:DescribeInstances
                Resource: "*"
                
              - Effect: Allow
                Action: cloudwatch:GetMetricStatistics
                Resource: '*'
              
              - Effect: Allow
                Action: cloudformation:DescribeStacks
                Resource: !Join
                  - ''
                  - - "arn:aws:cloudformation:"
                    - !Ref "AWS::Region"
                    - ':'
                    - !Ref "AWS::AccountId"
                    - ':stack/'
                    - !Ref "AWS::StackName"
                    - '/*'

              - Effect: Allow
                Action:
                  - dynamodb:CreateTable
                  - dynamodb:DeleteTable
                  - dynamodb:UpdateItem
                  - dynamodb:DescribeTable
                  - dynamodb:Scan
                  - dynamodb:Query
                  - dynamodb:GetItem
                  - dynamodb:BatchGetItem
                  - dynamodb:UpdateTable
                  - dynamodb:PutItem
                Resource: !Join
                  - ''
                  - - "arn:aws:dynamodb:"
                    - !Ref "AWS::Region"
                    - ':'
                    - !Ref "AWS::AccountId"
                    - ':table/HANAMonitor__'
                    - !Ref "AWS::StackName"
              - Effect: Allow
                Action:
                  - secretsmanager:GetSecretValue
                  - secretsmanager:DeleteSecret
                Resource:
                  - !Ref 'HANASecretManager'
                Condition:
                  StringLike: 
                    "secretsmanager:ResourceTag/aws:cloudformation:stack-id": !Ref AWS::StackId
                
  HANAIAMProfile:
    Type: AWS::IAM::InstanceProfile
    Properties:
      Path: /
      Roles:
        - !Ref 'HANAIAMRole'
  WaitForHANAInstall:
    Type: AWS::CloudFormation::WaitCondition
    DependsOn: HANAMasterInstance
    Properties:
      Handle: !Ref 'WaitForMasterInstallWaitHandle'
      Timeout: '7200'
  WaitForMasterInstallWaitHandle:
    Type: AWS::CloudFormation::WaitConditionHandle
    Properties: {}
  RDPInstanceRootRole:
    Condition: NeedWindowsInstance
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal:
              Service:
                - ec2.amazonaws.com
            Action:
              - sts:AssumeRole
      Path: /
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/service-role/AmazonEC2RoleforSSM
        - arn:aws:iam::aws:policy/AmazonS3ReadOnlyAccess
        - arn:aws:iam::aws:policy/AmazonEC2ReadOnlyAccess
        
  RDPProfile:
    Condition: NeedWindowsInstance
    Type: AWS::IAM::InstanceProfile
    Properties:
      Path: /
      Roles:
        - !Ref 'RDPInstanceRootRole'
  RDPSecurityGroup:
    Condition: NeedWindowsInstance
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupDescription: RDP Instance security group
      VpcId: !Ref 'VPCID'
      SecurityGroupIngress:
        - IpProtocol: tcp
          FromPort: 3389
          ToPort: 3389
          CidrIp: !Ref 'RemoteAccessCIDR'
      SecurityGroupEgress:
        - IpProtocol: tcp
          FromPort: 1
          ToPort: 65535
          CidrIp: '0.0.0.0/0'
  RDPEIP:
    Condition: NeedWindowsInstance
    Type: AWS::EC2::EIP
    Properties:
      Domain: vpc
  RDPInterface:
    Condition: NeedWindowsInstance
    Type: AWS::EC2::NetworkInterface
    Properties:
      SubnetId: !Ref 'DMZSubnet'
      Description: Interface for RDP Instance
      GroupSet:
        - !Ref 'RDPSecurityGroup'
      SourceDestCheck: true
      Tags:
        - Key: Network
          Value: Public
  AssociateRDPEIP:
    Condition: NeedWindowsInstance
    Type: AWS::EC2::EIPAssociation
    Properties:
      AllocationId: !GetAtt 'RDPEIP.AllocationId'
      NetworkInterfaceId: !Ref 'RDPInterface'
  RDPInstance:
    Condition: NeedWindowsInstance
    Type: AWS::EC2::Instance
    Properties:
      NetworkInterfaces:
        - NetworkInterfaceId: !Ref 'RDPInterface'
          DeviceIndex: '0'
      KeyName: !Ref 'KeyName'
      ImageId: !Ref 'LatestWS2012AmiId'
      IamInstanceProfile: !Ref 'RDPProfile'
      Tags:
        - Key: Name
          Value: SAP RDP Instance (Public Subnet)
        - Key: SAPHANAQuickStart
          Value: !Ref 'AWS::StackId'
      InstanceType: !Ref 'RDPInstanceType'
      UserData: !Base64
        Fn::Join:
          - ''
          - - "<powershell>\n"
            - "Set-ExecutionPolicy RemoteSigned -Force \n"
            - "Start-Process -FilePath msiexec -ArgumentList /i,  \"http://sdk-for-net.amazonwebservices.com/latest/AWSToolsAndSDKForNet.msi\"\
              , /passive -wait \n"
            - </powershell>

  HANAMasterInstance:
    Type: AWS::EC2::Instance
    Metadata:
      HostRole: Master
    Properties:
      HostId: !If
        - IfDedicatedHost
        - !Select
          - '0'
          - !Ref 'DedicatedHostId'
        - !Ref 'AWS::NoValue'
      NetworkInterfaces:
        - NetworkInterfaceId: !Ref 'HANAMasterInterface'
          DeviceIndex: '0'
      PlacementGroupName: !If
        - PlacementGroupNull
        - !Ref 'AWS::NoValue'
        - !Ref 'PlacementGroupName'
      KeyName: !Ref 'KeyName'
      BlockDeviceMappings:
        - DeviceName: /dev/sda1
          Ebs:
            VolumeSize: 50
            VolumeType: gp2
      ImageId: !FindInMap
        - AWSAMIRegionMap
        - !Ref 'AWS::Region'
        - !FindInMap
          - SAPAMINameMap
          - !Ref 'MyOS'
          - Code
      IamInstanceProfile: !Ref 'HANAIAMProfile'
      Tags:
        - Key: Name
          Value: SAP HANA Master
        - Key: SAPHANAQuickStart
          Value: !Ref AWS::StackId
      UserData: !Base64
        Fn::Join:
          - ''
          - - "#!/bin/bash -xv\n"
            - "mkdir /root/install \n"
            - 'hostname '
            - !Ref 'HANAMasterHostname'
            - "\n"
            - 'echo '
            - !Join
              - .
              - - !Ref 'HANAMasterHostname'
                - !Ref 'DomainName'
            - " > /etc/HOSTNAME\n"
            - 'echo '
            - !Join
              - .
              - - !Ref 'HANAMasterHostname'
                - !Ref 'DomainName'
            - " > /etc/hostname\n"
            - export http_proxy=
            - !Ref 'Proxy'
            - "\n"
            - export https_proxy=
            - !Ref 'Proxy'
            - "\n"
            - export HTTP_PROXY=
            - !Ref 'Proxy'
            - "\n"
            - export HTTPS_PROXY=
            - !Ref 'Proxy'
            - "\n"
            - export no_proxy=localhost,127.0.0.1,169.254.169.254
            - "\n"
            - export NO_PROXY=localhost,127.0.0.1,169.254.169.254
            - "\n"
            #- !If [IfUseSLES, "# SLES\n", "yum install -y wget\n", ]
            #- wget https://s3.amazonaws.com/
            #- !Ref 'PrivateBucket'
            #- "/scripts/download.sh --output-document=/root/install/download.sh\n"
            #- 'sh /root/install/download.sh -b '
            #- !Ref 'PrivateBucket'
            #- ' -c '
            #- !Ref 'CustomStorageConfig'
            #- "\n"
            - "source /etc/os-release\n"
            - "if [ ${ID} == \"sles\" ]; then \n"
            - "   zypper install -y aws-cli \n"
            - "elif [[ ${ID} == \"rhel\" && ${VERSION_ID} != \"7\"* ]]; then \n"
            - "   yum install -y python3 unzip \n"
            - "   curl \"https://s3.amazonaws.com/aws-cli/awscli-bundle.zip\" -o \"/tmp/awscli-bundle.zip\" \n"
            - "   cd /tmp && unzip awscli-bundle.zip \n"
            - "   python3 /tmp/awscli-bundle/install -i /usr/local/aws -b /usr/local/bin/aws \n"
            - "elif [[ ${ID} == \"rhel\" && ${VERSION_ID} == \"7.\"* ]]; then \n"
            - "   curl \"https://s3.amazonaws.com/aws-cli/awscli-bundle.zip\" -o \"/tmp/awscli-bundle.zip\" \n"
            - "   cd /tmp && unzip awscli-bundle.zip \n"
            - "   /tmp/awscli-bundle/install -i /usr/local/aws -b /usr/local/bin/aws \n"
            - "fi \n"
            - "cd /root/install && aws s3 sync s3://"
            - !Ref 'PrivateBucket'
            - "/scripts/ . \n"
            - "chmod 755 /root/install/*.sh\n"
            - "chmod 755 /root/install/*.py\n"
            - 'echo '
            - !Join
              - _
              - - export TABLE_NAME=HANAMonitor_
                - !Ref 'AWS::StackName'
            - " >> /root/install/config.sh\n"
            - 'echo '
            - !Join
              - ''
              - - export TZ_INPUT_PARAM=
                - !Ref 'SAPTZ'
            - " >> /root/install/config.sh\n"
            - 'echo '
            - !Join
              - ''
              - - export SLESBYOSRegCode=
                - !Ref 'SLESBYOSRegCode'
            - " >> /root/install/config.sh\n"
            - 'echo '
            - !Join
              - ''
              - - export DeploymentInterruptQ=
                - !Ref 'DeploymentInterruptQ'
            - " >> /root/install/config.sh\n"
            - 'echo '
            - !Join
              - ''
              - - export MyOS=
                - !FindInMap
                  - SAPAMINameMap
                  - !Ref 'MyOS'
                  - Code
            - " >> /root/install/config.sh\n"
            - sh /root/install/writeconfig.sh MyStackId=
            - !Ref 'AWS::StackId'
            - "\n"
            - sh  /root/install/writeconfig.sh MyStackName=
            - !Ref 'AWS::StackName'
            - "\n"
            - sh /root/install/writeconfig.sh INSTALL_HANA=
            - !Ref 'InstallHANA'
            - "\n"
            - sh /root/install/writeconfig.sh HostCount=
            - !Ref 'HostCount'
            - "\n"
            - sh /root/install/writeconfig.sh SAPInstanceNum=
            - !Ref 'SAPInstanceNum'
            - "\n"
            - sh /root/install/writeconfig.sh http_proxy=
            - !Ref 'Proxy'
            - "\n"
            - sh /root/install/writeconfig.sh HTTP_PROXY=
            - !Ref 'Proxy'
            - "\n"
            - sh /root/install/writeconfig.sh https_proxy=
            - !Ref 'Proxy'
            - "\n"
            - sh /root/install/writeconfig.sh HTTPS_PROXY=
            - !Ref 'Proxy'
            - "\n"
            - sh /root/install/writeconfig.sh AWSEFS=
            - !Ref 'AWSEFS'
            - "\n"
            - sh /root/install/writeconfig.sh EFSshared=
            - !If
               - UseEFS
               - !Ref 'EFSshared'
               - !Ref 'AWS::NoValue'
            - "\n"
            - sh /root/install/writeconfig.sh EFSbackup=
            - !If
               - UseEFS
               - !Ref 'EFSbackup'
               - !Ref 'AWS::NoValue'
            - "\n"
            - sh /root/install/writeconfig.sh no_proxy=localhost,127.0.0.1,169.254.169.254
            - "\n"
            - sh /root/install/writeconfig.sh NO_PROXY=localhost,127.0.0.1,169.254.169.254
            - "\n"
            - sh /root/install/writeconfig.sh FastRestartEnabled=
            - !Ref 'SAPHANAFastRestart'
            - "\n"
            
            - sh /root/install/writeconfig.sh DomainName=
            - !Ref 'DomainName'
            - "\n"
            - sh /root/install/writeconfig.sh SID=
            - !Ref 'SID'
            - "\n"
            - sh /root/install/writeconfig.sh HANAMasterPass=
            - !Ref 'HANAMasterPass'
            - "\n"
            - sh /root/install/writeconfig.sh HANAMasterHostname=
            - !Ref 'HANAMasterHostname'
            - "\n"
            - sh /root/install/writeconfig.sh HANAWorkerHostname=
            - !Ref 'HANAWorkerHostname'
            - "\n"

            - sh /root/install/writeconfig.sh IsMasterNode=1
            - "\n"
            - sh /root/install/writeconfig.sh IsWorkerNode=0
            - "\n"
            - sh /root/install/writeconfig.sh BACKUP_VOL=st1
            - "\n"
            - sh /root/install/writeconfig.sh SHARED_VOL=gp2
            - "\n"
            - sh /root/install/writeconfig.sh USR_SAP_VOL=gp2
            - "\n"
            - sh /root/install/writeconfig.sh HANA_MEDIA_VOL=gp2
            - "\n"
            - 'echo '
            - !Join
              - ''
              - - '"'
                - export WaitForMasterInstallWaitHandle=
                - \
                - '"'
                - !Ref 'WaitForMasterInstallWaitHandle'
                - \
                - '"'
                - '"'
            - " >> /root/install/config.sh\n"
            - sh /root/install/writeconfig.sh REGION=
            - !Ref 'AWS::Region'
            - "\n"
            - sh /root/install/writeconfig.sh AutomaticReboot=
            - !Ref 'AutomaticReboot'
            - "\n"
            - "sh /root/install/install-prereq.sh\n"
            - "sh /root/install/install-aws.sh\n"
            - "sh /root/install/setup-hana.sh master\n"
            - "\n"
      InstanceType: !Ref 'MyInstanceType'
  PlacementGroup:
    Type: AWS::EC2::PlacementGroup
    Properties:
      Strategy: cluster

  HANAWorkerInstance1:
    Type: AWS::EC2::Instance
    Condition: TwoOrMoreNodes
    Metadata:
      HostRole: Worker
    Properties:
      HostId: !If
        - IfDedicatedHost
        - !Select
          - '1'
          - !Ref 'DedicatedHostId'
        - !Ref 'AWS::NoValue'
      NetworkInterfaces:
        - NetworkInterfaceId: !Ref 'HANAWorker1Interface'
          DeviceIndex: '0'
      PlacementGroupName: !If
        - PlacementGroupNull
        - !Ref 'AWS::NoValue'
        - !Ref 'PlacementGroupName'
      KeyName: !Ref 'KeyName'
      BlockDeviceMappings:
        - DeviceName: /dev/sda1
          Ebs:
            VolumeSize: 50
            VolumeType: gp2
      ImageId: !FindInMap
        - AWSAMIRegionMap
        - !Ref 'AWS::Region'
        - !FindInMap
          - SAPAMINameMap
          - !Ref 'MyOS'
          - Code
      IamInstanceProfile: !Ref 'HANAIAMProfile'
      Tags:
        - Key: Name
          Value: SAP HANA Worker 1
        - Key: SAPHANAQuickStart
          Value: !Ref AWS::StackId
      UserData: !Base64
        Fn::Join:
          - ''
          - - "#!/bin/bash -xv\n"
            - "mkdir /root/install \n"
            - 'hostname '
            - !Join
              - ''
              - - !Ref 'HANAWorkerHostname'
                - '01'
            - "\n"
            - 'echo '
            - !Join
              - ''
              - - !Ref 'HANAWorkerHostname'
                - '01'
                - .
                - !Ref 'DomainName'
            - " > /etc/HOSTNAME\n"
            - 'echo '
            - !Join
              - ''
              - - !Ref 'HANAWorkerHostname'
                - '01'
                - .
                - !Ref 'DomainName'
            - " > /etc/hostname\n"
            - export http_proxy=
            - !Ref 'Proxy'
            - "\n"
            - export https_proxy=
            - !Ref 'Proxy'
            - "\n"
            - export HTTP_PROXY=
            - !Ref 'Proxy'
            - "\n"
            - export HTTPS_PROXY=
            - !Ref 'Proxy'
            - "\n"
            - sh /root/install/writeconfig.sh AWSEFS=
            - !Ref 'AWSEFS'
            - "\n"
            - sh /root/install/writeconfig.sh EFSshared=
            - !If
               - UseEFS
               - !Ref 'EFSshared'
               - !Ref 'AWS::NoValue'
            - "\n"
            - sh /root/install/writeconfig.sh EFSbackup=
            - !If
               - UseEFS
               - !Ref 'EFSbackup'
               - !Ref 'AWS::NoValue'
            - "\n"
            - export no_proxy=localhost,127.0.0.1,169.254.169.254
            - "\n"
            - export NO_PROXY=localhost,127.0.0.1,169.254.169.254
            - "\n"
            #- !If [IfUseSLES, "# SLES\n", "yum install -y wget\n", ]
            #- wget https://s3.amazonaws.com/
            #- !Ref 'PrivateBucket'
            #- "/scripts/download.sh --output-document=/root/install/download.sh\n"
            #- 'sh /root/install/download.sh -b '
            #- !Ref 'PrivateBucket'
            #- ' -c '
            #- !Ref 'CustomStorageConfig'
            #- "\n"
            - "source /etc/os-release\n"
            - "if [ ${ID} == \"sles\" ]; then \n"
            - "   zypper install -y aws-cli \n"
            - "elif [[ ${ID} == \"rhel\" && ${VERSION_ID} != \"7\"* ]]; then \n"
            - "   yum install -y python3 unzip \n"
            - "   curl \"https://s3.amazonaws.com/aws-cli/awscli-bundle.zip\" -o \"/tmp/awscli-bundle.zip\" \n"
            - "   cd /tmp && unzip awscli-bundle.zip \n"
            - "   python3 /tmp/awscli-bundle/install -i /usr/local/aws -b /usr/local/bin/aws \n"
            - "elif [[ ${ID} == \"rhel\" && ${VERSION_ID} == \"7.\"* ]]; then \n"
            - "   curl \"https://s3.amazonaws.com/aws-cli/awscli-bundle.zip\" -o \"/tmp/awscli-bundle.zip\" \n"
            - "   cd /tmp && unzip awscli-bundle.zip \n"
            - "   /tmp/awscli-bundle/install -i /usr/local/aws -b /usr/local/bin/aws \n"
            - "fi \n"
            - "cd /root/install && aws s3 sync s3://"
            - !Ref 'PrivateBucket'
            - "/scripts/ . \n"
            - "chmod 755 /root/install/*.sh\n"
            - "chmod 755 /root/install/*.py\n"
            - 'echo '
            - !Join
              - _
              - - export TABLE_NAME=HANAMonitor_
                - !Ref 'AWS::StackName'
            - " >> /root/install/config.sh\n"
            - 'echo '
            - !Join
              - ''
              - - export TZ_INPUT_PARAM=
                - !Ref 'SAPTZ'
            - " >> /root/install/config.sh\n"
            - 'echo '
            - !Join
              - ''
              - - export SLESBYOSRegCode=
                - !Ref 'SLESBYOSRegCode'
            - " >> /root/install/config.sh\n"
            - 'echo '
            - !Join
              - ''
              - - export DeploymentInterruptQ=
                - !Ref 'DeploymentInterruptQ'
            - " >> /root/install/config.sh\n"
            - 'echo '
            - !Join
              - ''
              - - export MyOS=
                - !FindInMap
                  - SAPAMINameMap
                  - !Ref 'MyOS'
                  - Code
            - " >> /root/install/config.sh\n"
            - sh /root/install/writeconfig.sh MyStackId=
            - !Ref 'AWS::StackId'
            - "\n"
            - sh  /root/install/writeconfig.sh MyStackName=
            - !Ref 'AWS::StackName'
            - "\n"
            - sh /root/install/writeconfig.sh INSTALL_HANA=
            - !Ref 'InstallHANA'
            - "\n"
            - sh /root/install/writeconfig.sh HostCount=
            - !Ref 'HostCount'
            - "\n"
            - sh /root/install/writeconfig.sh SAPInstanceNum=
            - !Ref 'SAPInstanceNum'
            - "\n"
            - sh /root/install/writeconfig.sh http_proxy=
            - !Ref 'Proxy'
            - "\n"
            - sh /root/install/writeconfig.sh HTTP_PROXY=
            - !Ref 'Proxy'
            - "\n"
            - sh /root/install/writeconfig.sh https_proxy=
            - !Ref 'Proxy'
            - "\n"
            - sh /root/install/writeconfig.sh HTTPS_PROXY=
            - !Ref 'Proxy'
            - "\n"
            - sh /root/install/writeconfig.sh AWSEFS=
            - !Ref 'AWSEFS'
            - "\n"
            - sh /root/install/writeconfig.sh EFSshared=
            - !If
               - UseEFS
               - !Ref 'EFSshared'
               - !Ref 'AWS::NoValue'
            - "\n"
            - sh /root/install/writeconfig.sh EFSbackup=
            - !If
               - UseEFS
               - !Ref 'EFSbackup'
               - !Ref 'AWS::NoValue'
            - "\n"
            - sh /root/install/writeconfig.sh no_proxy=localhost,127.0.0.1,169.254.169.254
            - "\n"
            - sh /root/install/writeconfig.sh NO_PROXY=localhost,127.0.0.1,169.254.169.254
            - "\n"
            - sh /root/install/writeconfig.sh FastRestartEnabled=
            - !Ref 'SAPHANAFastRestart'
            - "\n"
            - sh /root/install/writeconfig.sh DomainName=
            - !Ref 'DomainName'
            - "\n"
            - sh /root/install/writeconfig.sh SID=
            - !Ref 'SID'
            - "\n"
            - sh /root/install/writeconfig.sh IsMasterNode=0
            - "\n"
            - sh /root/install/writeconfig.sh IsWorkerNode=1
            - "\n"
            - sh /root/install/writeconfig.sh USR_SAP_VOL=gp2
            - "\n"
            - sh /root/install/writeconfig.sh REGION=
            - !Ref 'AWS::Region'
            - "\n"
            - sh /root/install/writeconfig.sh AutomaticReboot=
            - !Ref 'AutomaticReboot'
            - "\n"
            - sh /root/install/writeconfig.sh HANAMasterHostname=
            - !Ref 'HANAMasterHostname'
            - "\n"
            - "sh /root/install/install-prereq.sh\n"
            - "sh /root/install/install-aws.sh\n"
            - "sh /root/install/setup-hana.sh worker\n"
            - "\n"
      InstanceType: !Ref 'MyInstanceType'
  HANAWorkerInstance2:
    Type: AWS::EC2::Instance
    Condition: ThreeOrMoreNodes
    Metadata:
      HostRole: Worker
    Properties:
      HostId: !If
        - IfDedicatedHost
        - !Select
          - '2'
          - !Ref 'DedicatedHostId'
        - !Ref 'AWS::NoValue'
      NetworkInterfaces:
        - NetworkInterfaceId: !Ref 'HANAWorker2Interface'
          DeviceIndex: '0'
      PlacementGroupName: !If
        - PlacementGroupNull
        - !Ref 'AWS::NoValue'
        - !Ref 'PlacementGroupName'
      KeyName: !Ref 'KeyName'
      BlockDeviceMappings:
        - DeviceName: /dev/sda1
          Ebs:
            VolumeSize: 50
            VolumeType: gp2
      ImageId: !FindInMap
        - AWSAMIRegionMap
        - !Ref 'AWS::Region'
        - !FindInMap
          - SAPAMINameMap
          - !Ref 'MyOS'
          - Code
      IamInstanceProfile: !Ref 'HANAIAMProfile'
      Tags:
        - Key: Name
          Value: SAP HANA Worker 2
        - Key: SAPHANAQuickStart
          Value: !Ref AWS::StackId
      UserData: !Base64
        Fn::Join:
          - ''
          - - "#!/bin/bash -xv\n"
            - "mkdir /root/install \n"
            - 'hostname '
            - !Join
              - ''
              - - !Ref 'HANAWorkerHostname'
                - '02'
            - "\n"
            - 'echo '
            - !Join
              - ''
              - - !Ref 'HANAWorkerHostname'
                - '02'
                - .
                - !Ref 'DomainName'
            - " > /etc/HOSTNAME\n"
            - 'echo '
            - !Join
              - ''
              - - !Ref 'HANAWorkerHostname'
                - '02'
                - .
                - !Ref 'DomainName'
            - " > /etc/hostname\n"
            - export http_proxy=
            - !Ref 'Proxy'
            - "\n"
            - export https_proxy=
            - !Ref 'Proxy'
            - "\n"
            - export HTTP_PROXY=
            - !Ref 'Proxy'
            - "\n"
            - export HTTPS_PROXY=
            - !Ref 'Proxy'
            - "\n"
            - sh /root/install/writeconfig.sh AWSEFS=
            - !Ref 'AWSEFS'
            - "\n"
            - sh /root/install/writeconfig.sh EFSshared=
            - !If
               - UseEFS
               - !Ref 'EFSshared'
               - !Ref 'AWS::NoValue'
            - "\n"
            - sh /root/install/writeconfig.sh EFSbackup=
            - !If
               - UseEFS
               - !Ref 'EFSbackup'
               - !Ref 'AWS::NoValue'
            - "\n"
            - export no_proxy=localhost,127.0.0.1,169.254.169.254
            - "\n"
            - export NO_PROXY=localhost,127.0.0.1,169.254.169.254
            - "\n"
            #- !If [IfUseSLES, "# SLES\n", "yum install -y wget\n", ]
            #- wget https://s3.amazonaws.com/
            #- !Ref 'PrivateBucket'
            #- "/scripts/download.sh --output-document=/root/install/download.sh\n"
            #- 'sh /root/install/download.sh -b '
            #- !Ref 'PrivateBucket'
            #- ' -c '
            #- !Ref 'CustomStorageConfig'
            #- "\n"
            - "source /etc/os-release\n"
            - "if [ ${ID} == \"sles\" ]; then \n"
            - "   zypper install -y aws-cli \n"
            - "elif [[ ${ID} == \"rhel\" && ${VERSION_ID} != \"7\"* ]]; then \n"
            - "   yum install -y python3 unzip \n"
            - "   curl \"https://s3.amazonaws.com/aws-cli/awscli-bundle.zip\" -o \"/tmp/awscli-bundle.zip\" \n"
            - "   cd /tmp && unzip awscli-bundle.zip \n"
            - "   python3 /tmp/awscli-bundle/install -i /usr/local/aws -b /usr/local/bin/aws \n"
            - "elif [[ ${ID} == \"rhel\" && ${VERSION_ID} == \"7.\"* ]]; then \n"
            - "   curl \"https://s3.amazonaws.com/aws-cli/awscli-bundle.zip\" -o \"/tmp/awscli-bundle.zip\" \n"
            - "   cd /tmp && unzip awscli-bundle.zip \n"
            - "   /tmp/awscli-bundle/install -i /usr/local/aws -b /usr/local/bin/aws \n"
            - "fi \n"
            - "cd /root/install && aws s3 sync s3://"
            - !Ref 'PrivateBucket'
            - "/scripts/ . \n"
            - "chmod 755 /root/install/*.sh\n"
            - "chmod 755 /root/install/*.py\n"
            - 'echo '
            - !Join
              - _
              - - export TABLE_NAME=HANAMonitor_
                - !Ref 'AWS::StackName'
            - " >> /root/install/config.sh\n"
            - 'echo '
            - !Join
              - ''
              - - export TZ_INPUT_PARAM=
                - !Ref 'SAPTZ'
            - " >> /root/install/config.sh\n"
            - 'echo '
            - !Join
              - ''
              - - export SLESBYOSRegCode=
                - !Ref 'SLESBYOSRegCode'
            - " >> /root/install/config.sh\n"
            - 'echo '
            - !Join
              - ''
              - - export DeploymentInterruptQ=
                - !Ref 'DeploymentInterruptQ'
            - " >> /root/install/config.sh\n"
            - 'echo '
            - !Join
              - ''
              - - export MyOS=
                - !FindInMap
                  - SAPAMINameMap
                  - !Ref 'MyOS'
                  - Code
            - " >> /root/install/config.sh\n"
            - sh /root/install/writeconfig.sh MyStackId=
            - !Ref 'AWS::StackId'
            - "\n"
            - sh  /root/install/writeconfig.sh MyStackName=
            - !Ref 'AWS::StackName'
            - "\n"
            - sh /root/install/writeconfig.sh INSTALL_HANA=
            - !Ref 'InstallHANA'
            - "\n"
            - sh /root/install/writeconfig.sh HostCount=
            - !Ref 'HostCount'
            - "\n"
            - sh /root/install/writeconfig.sh SAPInstanceNum=
            - !Ref 'SAPInstanceNum'
            - "\n"
            - sh /root/install/writeconfig.sh http_proxy=
            - !Ref 'Proxy'
            - "\n"
            - sh /root/install/writeconfig.sh HTTP_PROXY=
            - !Ref 'Proxy'
            - "\n"
            - sh /root/install/writeconfig.sh https_proxy=
            - !Ref 'Proxy'
            - "\n"
            - sh /root/install/writeconfig.sh HTTPS_PROXY=
            - !Ref 'Proxy'
            - "\n"
            - sh /root/install/writeconfig.sh AWSEFS=
            - !Ref 'AWSEFS'
            - "\n"
            - sh /root/install/writeconfig.sh EFSshared=
            - !If
               - UseEFS
               - !Ref 'EFSshared'
               - !Ref 'AWS::NoValue'
            - "\n"
            - sh /root/install/writeconfig.sh EFSbackup=
            - !If
               - UseEFS
               - !Ref 'EFSbackup'
               - !Ref 'AWS::NoValue'
            - "\n"
            - sh /root/install/writeconfig.sh no_proxy=localhost,127.0.0.1,169.254.169.254
            - "\n"
            - sh /root/install/writeconfig.sh NO_PROXY=localhost,127.0.0.1,169.254.169.254
            - "\n"
            - sh /root/install/writeconfig.sh FastRestartEnabled=
            - !Ref 'SAPHANAFastRestart'
            - "\n"
            - sh /root/install/writeconfig.sh DomainName=
            - !Ref 'DomainName'
            - "\n"
            - sh /root/install/writeconfig.sh SID=
            - !Ref 'SID'
            - "\n"
            - sh /root/install/writeconfig.sh IsMasterNode=0
            - "\n"
            - sh /root/install/writeconfig.sh IsWorkerNode=1
            - "\n"
            - sh /root/install/writeconfig.sh USR_SAP_VOL=gp2
            - "\n"
            - sh /root/install/writeconfig.sh REGION=
            - !Ref 'AWS::Region'
            - "\n"
            - sh /root/install/writeconfig.sh AutomaticReboot=
            - !Ref 'AutomaticReboot'
            - "\n"
            - sh /root/install/writeconfig.sh HANAMasterHostname=
            - !Ref 'HANAMasterHostname'
            - "\n"
            - "sh /root/install/install-prereq.sh\n"
            - "sh /root/install/install-aws.sh\n"
            - "sh /root/install/setup-hana.sh worker\n"
            - "\n"
      InstanceType: !Ref 'MyInstanceType'
  HANAWorkerInstance3:
    Type: AWS::EC2::Instance
    Condition: FourOrMoreNodes
    Metadata:
      HostRole: Worker
    Properties:
      HostId: !If
        - IfDedicatedHost
        - !Select
          - '3'
          - !Ref 'DedicatedHostId'
        - !Ref 'AWS::NoValue'
      NetworkInterfaces:
        - NetworkInterfaceId: !Ref 'HANAWorker3Interface'
          DeviceIndex: '0'
      PlacementGroupName: !If
        - PlacementGroupNull
        - !Ref 'AWS::NoValue'
        - !Ref 'PlacementGroupName'
      KeyName: !Ref 'KeyName'
      BlockDeviceMappings:
        - DeviceName: /dev/sda1
          Ebs:
            VolumeSize: 50
            VolumeType: gp2
      ImageId: !FindInMap
        - AWSAMIRegionMap
        - !Ref 'AWS::Region'
        - !FindInMap
          - SAPAMINameMap
          - !Ref 'MyOS'
          - Code
      IamInstanceProfile: !Ref 'HANAIAMProfile'
      Tags:
        - Key: Name
          Value: SAP HANA Worker 3
        - Key: SAPHANAQuickStart
          Value: !Ref AWS::StackId
      UserData: !Base64
        Fn::Join:
          - ''
          - - "#!/bin/bash -xv\n"
            - "mkdir /root/install \n"
            - 'hostname '
            - !Join
              - ''
              - - !Ref 'HANAWorkerHostname'
                - '03'
            - "\n"
            - 'echo '
            - !Join
              - ''
              - - !Ref 'HANAWorkerHostname'
                - '03'
                - .
                - !Ref 'DomainName'
            - " > /etc/HOSTNAME\n"
            - 'echo '
            - !Join
              - ''
              - - !Ref 'HANAWorkerHostname'
                - '03'
                - .
                - !Ref 'DomainName'
            - " > /etc/hostname\n"
            - export http_proxy=
            - !Ref 'Proxy'
            - "\n"
            - export https_proxy=
            - !Ref 'Proxy'
            - "\n"
            - export HTTP_PROXY=
            - !Ref 'Proxy'
            - "\n"
            - export HTTPS_PROXY=
            - !Ref 'Proxy'
            - "\n"
            - sh /root/install/writeconfig.sh AWSEFS=
            - !Ref 'AWSEFS'
            - "\n"
            - sh /root/install/writeconfig.sh EFSshared=
            - !If
               - UseEFS
               - !Ref 'EFSshared'
               - !Ref 'AWS::NoValue'
            - "\n"
            - sh /root/install/writeconfig.sh EFSbackup=
            - !If
               - UseEFS
               - !Ref 'EFSbackup'
               - !Ref 'AWS::NoValue'
            - "\n"
            - export no_proxy=localhost,127.0.0.1,169.254.169.254
            - "\n"
            - export NO_PROXY=localhost,127.0.0.1,169.254.169.254
            - "\n"
            #- !If [IfUseSLES, "# SLES\n", "yum install -y wget\n", ]
            #- wget https://s3.amazonaws.com/
            #- !Ref 'PrivateBucket'
            #- "/scripts/download.sh --output-document=/root/install/download.sh\n"
            #- 'sh /root/install/download.sh -b '
            #- !Ref 'PrivateBucket'
            #- ' -c '
            #- !Ref 'CustomStorageConfig'
            #- "\n"
            - "source /etc/os-release\n"
            - "if [ ${ID} == \"sles\" ]; then \n"
            - "   zypper install -y aws-cli \n"
            - "elif [[ ${ID} == \"rhel\" && ${VERSION_ID} != \"7\"* ]]; then \n"
            - "   yum install -y python3 unzip \n"
            - "   curl \"https://s3.amazonaws.com/aws-cli/awscli-bundle.zip\" -o \"/tmp/awscli-bundle.zip\" \n"
            - "   cd /tmp && unzip awscli-bundle.zip \n"
            - "   python3 /tmp/awscli-bundle/install -i /usr/local/aws -b /usr/local/bin/aws \n"
            - "elif [[ ${ID} == \"rhel\" && ${VERSION_ID} == \"7.\"* ]]; then \n"
            - "   curl \"https://s3.amazonaws.com/aws-cli/awscli-bundle.zip\" -o \"/tmp/awscli-bundle.zip\" \n"
            - "   cd /tmp && unzip awscli-bundle.zip \n"
            - "   /tmp/awscli-bundle/install -i /usr/local/aws -b /usr/local/bin/aws \n"
            - "fi \n"
            - "cd /root/install && aws s3 sync s3://"
            - !Ref 'PrivateBucket'
            - "/scripts/ . \n"
            - "chmod 755 /root/install/*.sh\n"
            - "chmod 755 /root/install/*.py\n"
            - 'echo '
            - !Join
              - _
              - - export TABLE_NAME=HANAMonitor_
                - !Ref 'AWS::StackName'
            - " >> /root/install/config.sh\n"
            - 'echo '
            - !Join
              - ''
              - - export TZ_INPUT_PARAM=
                - !Ref 'SAPTZ'
            - " >> /root/install/config.sh\n"
            - 'echo '
            - !Join
              - ''
              - - export SLESBYOSRegCode=
                - !Ref 'SLESBYOSRegCode'
            - " >> /root/install/config.sh\n"
            - 'echo '
            - !Join
              - ''
              - - export DeploymentInterruptQ=
                - !Ref 'DeploymentInterruptQ'
            - " >> /root/install/config.sh\n"
            - 'echo '
            - !Join
              - ''
              - - export MyOS=
                - !FindInMap
                  - SAPAMINameMap
                  - !Ref 'MyOS'
                  - Code
            - " >> /root/install/config.sh\n"
            - sh /root/install/writeconfig.sh MyStackId=
            - !Ref 'AWS::StackId'
            - "\n"
            - sh  /root/install/writeconfig.sh MyStackName=
            - !Ref 'AWS::StackName'
            - "\n"
            - sh /root/install/writeconfig.sh INSTALL_HANA=
            - !Ref 'InstallHANA'
            - "\n"
            - sh /root/install/writeconfig.sh HostCount=
            - !Ref 'HostCount'
            - "\n"
            - sh /root/install/writeconfig.sh SAPInstanceNum=
            - !Ref 'SAPInstanceNum'
            - "\n"
            - sh /root/install/writeconfig.sh http_proxy=
            - !Ref 'Proxy'
            - "\n"
            - sh /root/install/writeconfig.sh HTTP_PROXY=
            - !Ref 'Proxy'
            - "\n"
            - sh /root/install/writeconfig.sh https_proxy=
            - !Ref 'Proxy'
            - "\n"
            - sh /root/install/writeconfig.sh HTTPS_PROXY=
            - !Ref 'Proxy'
            - "\n"
            - sh /root/install/writeconfig.sh AWSEFS=
            - !Ref 'AWSEFS'
            - "\n"
            - sh /root/install/writeconfig.sh EFSshared=
            - !If
               - UseEFS
               - !Ref 'EFSshared'
               - !Ref 'AWS::NoValue'
            - "\n"
            - sh /root/install/writeconfig.sh EFSbackup=
            - !If
               - UseEFS
               - !Ref 'EFSbackup'
               - !Ref 'AWS::NoValue'
            - "\n"
            - sh /root/install/writeconfig.sh no_proxy=localhost,127.0.0.1,169.254.169.254
            - "\n"
            - sh /root/install/writeconfig.sh NO_PROXY=localhost,127.0.0.1,169.254.169.254
            - "\n"
            - sh /root/install/writeconfig.sh FastRestartEnabled=
            - !Ref 'SAPHANAFastRestart'
            - "\n"
            - sh /root/install/writeconfig.sh DomainName=
            - !Ref 'DomainName'
            - "\n"
            - sh /root/install/writeconfig.sh SID=
            - !Ref 'SID'
            - "\n"
            - sh /root/install/writeconfig.sh IsMasterNode=0
            - "\n"
            - sh /root/install/writeconfig.sh IsWorkerNode=1
            - "\n"
            - sh /root/install/writeconfig.sh USR_SAP_VOL=gp2
            - "\n"
            - sh /root/install/writeconfig.sh REGION=
            - !Ref 'AWS::Region'
            - "\n"
            - sh /root/install/writeconfig.sh AutomaticReboot=
            - !Ref 'AutomaticReboot'
            - "\n"
            - sh /root/install/writeconfig.sh HANAMasterHostname=
            - !Ref 'HANAMasterHostname'
            - "\n"
            - "sh /root/install/install-prereq.sh\n"
            - "sh /root/install/install-aws.sh\n"
            - "sh /root/install/setup-hana.sh worker\n"
            - "\n"
      InstanceType: !Ref 'MyInstanceType'
  HANAWorkerInstance4:
    Type: AWS::EC2::Instance
    Condition: FiveOrMoreNodes
    Metadata:
      HostRole: Worker
    Properties:
      HostId: !If
        - IfDedicatedHost
        - !Select
          - '4'
          - !Ref 'DedicatedHostId'
        - !Ref 'AWS::NoValue'
      NetworkInterfaces:
        - NetworkInterfaceId: !Ref 'HANAWorker4Interface'
          DeviceIndex: '0'
      PlacementGroupName: !If
        - PlacementGroupNull
        - !Ref 'AWS::NoValue'
        - !Ref 'PlacementGroupName'
      KeyName: !Ref 'KeyName'
      BlockDeviceMappings:
        - DeviceName: /dev/sda1
          Ebs:
            VolumeSize: 50
            VolumeType: gp2
      ImageId: !FindInMap
        - AWSAMIRegionMap
        - !Ref 'AWS::Region'
        - !FindInMap
          - SAPAMINameMap
          - !Ref 'MyOS'
          - Code
      IamInstanceProfile: !Ref 'HANAIAMProfile'
      Tags:
        - Key: Name
          Value: SAP HANA Worker 4
        - Key: SAPHANAQuickStart
          Value: !Ref AWS::StackId
      UserData: !Base64
        Fn::Join:
          - ''
          - - "#!/bin/bash -xv\n"
            - "mkdir /root/install \n"
            - 'hostname '
            - !Join
              - ''
              - - !Ref 'HANAWorkerHostname'
                - '04'
            - "\n"
            - 'echo '
            - !Join
              - ''
              - - !Ref 'HANAWorkerHostname'
                - '04'
                - .
                - !Ref 'DomainName'
            - " > /etc/HOSTNAME\n"
            - 'echo '
            - !Join
              - ''
              - - !Ref 'HANAWorkerHostname'
                - '04'
                - .
                - !Ref 'DomainName'
            - " > /etc/hostname\n"
            - export http_proxy=
            - !Ref 'Proxy'
            - "\n"
            - export https_proxy=
            - !Ref 'Proxy'
            - "\n"
            - export HTTP_PROXY=
            - !Ref 'Proxy'
            - "\n"
            - export HTTPS_PROXY=
            - !Ref 'Proxy'
            - "\n"
            - sh /root/install/writeconfig.sh AWSEFS=
            - !Ref 'AWSEFS'
            - "\n"
            - sh /root/install/writeconfig.sh EFSshared=
            - !If
               - UseEFS
               - !Ref 'EFSshared'
               - !Ref 'AWS::NoValue'
            - "\n"
            - sh /root/install/writeconfig.sh EFSbackup=
            - !If
               - UseEFS
               - !Ref 'EFSbackup'
               - !Ref 'AWS::NoValue'
            - "\n"
            - export no_proxy=localhost,127.0.0.1,169.254.169.254
            - "\n"
            - export NO_PROXY=localhost,127.0.0.1,169.254.169.254
            - "\n"
            #- !If [IfUseSLES, "# SLES\n", "yum install -y wget\n", ]
            #- wget https://s3.amazonaws.com/
            #- !Ref 'PrivateBucket'
            #- "/scripts/download.sh --output-document=/root/install/download.sh\n"
            #- 'sh /root/install/download.sh -b '
            #- !Ref 'PrivateBucket'
            #- ' -c '
            #- !Ref 'CustomStorageConfig'
            #- "\n"
            - "source /etc/os-release\n"
            - "if [ ${ID} == \"sles\" ]; then \n"
            - "   zypper install -y aws-cli \n"
            - "elif [[ ${ID} == \"rhel\" && ${VERSION_ID} != \"7\"* ]]; then \n"
            - "   yum install -y python3 unzip \n"
            - "   curl \"https://s3.amazonaws.com/aws-cli/awscli-bundle.zip\" -o \"/tmp/awscli-bundle.zip\" \n"
            - "   cd /tmp && unzip awscli-bundle.zip \n"
            - "   python3 /tmp/awscli-bundle/install -i /usr/local/aws -b /usr/local/bin/aws \n"
            - "elif [[ ${ID} == \"rhel\" && ${VERSION_ID} == \"7.\"* ]]; then \n"
            - "   curl \"https://s3.amazonaws.com/aws-cli/awscli-bundle.zip\" -o \"/tmp/awscli-bundle.zip\" \n"
            - "   cd /tmp && unzip awscli-bundle.zip \n"
            - "   /tmp/awscli-bundle/install -i /usr/local/aws -b /usr/local/bin/aws \n"
            - "fi \n"
            - "cd /root/install && aws s3 sync s3://"
            - !Ref 'PrivateBucket'
            - "/scripts/ . \n"
            - "chmod 755 /root/install/*.sh\n"
            - "chmod 755 /root/install/*.py\n"
            - 'echo '
            - !Join
              - _
              - - export TABLE_NAME=HANAMonitor_
                - !Ref 'AWS::StackName'
            - " >> /root/install/config.sh\n"
            - 'echo '
            - !Join
              - ''
              - - export TZ_INPUT_PARAM=
                - !Ref 'SAPTZ'
            - " >> /root/install/config.sh\n"
            - 'echo '
            - !Join
              - ''
              - - export SLESBYOSRegCode=
                - !Ref 'SLESBYOSRegCode'
            - " >> /root/install/config.sh\n"
            - 'echo '
            - !Join
              - ''
              - - export DeploymentInterruptQ=
                - !Ref 'DeploymentInterruptQ'
            - " >> /root/install/config.sh\n"
            - 'echo '
            - !Join
              - ''
              - - export MyOS=
                - !FindInMap
                  - SAPAMINameMap
                  - !Ref 'MyOS'
                  - Code
            - " >> /root/install/config.sh\n"
            - sh /root/install/writeconfig.sh MyStackId=
            - !Ref 'AWS::StackId'
            - "\n"
            - sh  /root/install/writeconfig.sh MyStackName=
            - !Ref 'AWS::StackName'
            - "\n"
            - sh /root/install/writeconfig.sh INSTALL_HANA=
            - !Ref 'InstallHANA'
            - "\n"
            - sh /root/install/writeconfig.sh HostCount=
            - !Ref 'HostCount'
            - "\n"
            - sh /root/install/writeconfig.sh SAPInstanceNum=
            - !Ref 'SAPInstanceNum'
            - "\n"
            - sh /root/install/writeconfig.sh http_proxy=
            - !Ref 'Proxy'
            - "\n"
            - sh /root/install/writeconfig.sh HTTP_PROXY=
            - !Ref 'Proxy'
            - "\n"
            - sh /root/install/writeconfig.sh https_proxy=
            - !Ref 'Proxy'
            - "\n"
            - sh /root/install/writeconfig.sh HTTPS_PROXY=
            - !Ref 'Proxy'
            - "\n"
            - sh /root/install/writeconfig.sh AWSEFS=
            - !Ref 'AWSEFS'
            - "\n"
            - sh /root/install/writeconfig.sh EFSshared=
            - !If
               - UseEFS
               - !Ref 'EFSshared'
               - !Ref 'AWS::NoValue'
            - "\n"
            - sh /root/install/writeconfig.sh EFSbackup=
            - !If
               - UseEFS
               - !Ref 'EFSbackup'
               - !Ref 'AWS::NoValue'
            - "\n"
            - sh /root/install/writeconfig.sh no_proxy=localhost,127.0.0.1,169.254.169.254
            - "\n"
            - sh /root/install/writeconfig.sh NO_PROXY=localhost,127.0.0.1,169.254.169.254
            - "\n"
            - sh /root/install/writeconfig.sh FastRestartEnabled=
            - !Ref 'SAPHANAFastRestart'
            - "\n"
            - sh /root/install/writeconfig.sh DomainName=
            - !Ref 'DomainName'
            - "\n"
            - sh /root/install/writeconfig.sh SID=
            - !Ref 'SID'
            - "\n"
            - sh /root/install/writeconfig.sh IsMasterNode=0
            - "\n"
            - sh /root/install/writeconfig.sh IsWorkerNode=1
            - "\n"
            - sh /root/install/writeconfig.sh USR_SAP_VOL=gp2
            - "\n"
            - sh /root/install/writeconfig.sh REGION=
            - !Ref 'AWS::Region'
            - "\n"
            - sh /root/install/writeconfig.sh AutomaticReboot=
            - !Ref 'AutomaticReboot'
            - "\n"
            - sh /root/install/writeconfig.sh HANAMasterHostname=
            - !Ref 'HANAMasterHostname'
            - "\n"
            - "sh /root/install/install-prereq.sh\n"
            - "sh /root/install/install-aws.sh\n"
            - "sh /root/install/setup-hana.sh worker\n"
            - "\n"
      InstanceType: !Ref 'MyInstanceType'
  HANAWorkerInstance5:
    Type: AWS::EC2::Instance
    Condition: SixOrMoreNodes
    Metadata:
      HostRole: Worker
    Properties:
      HostId: !If
        - IfDedicatedHost
        - !Select
          - '5'
          - !Ref 'DedicatedHostId'
        - !Ref 'AWS::NoValue'
      NetworkInterfaces:
        - NetworkInterfaceId: !Ref 'HANAWorker5Interface'
          DeviceIndex: '0'
      PlacementGroupName: !If
        - PlacementGroupNull
        - !Ref 'AWS::NoValue'
        - !Ref 'PlacementGroupName'
      KeyName: !Ref 'KeyName'
      BlockDeviceMappings:
        - DeviceName: /dev/sda1
          Ebs:
            VolumeSize: 50
            VolumeType: gp2
      ImageId: !FindInMap
        - AWSAMIRegionMap
        - !Ref 'AWS::Region'
        - !FindInMap
          - SAPAMINameMap
          - !Ref 'MyOS'
          - Code
      IamInstanceProfile: !Ref 'HANAIAMProfile'
      Tags:
        - Key: Name
          Value: SAP HANA Worker 5
        - Key: SAPHANAQuickStart
          Value: !Ref AWS::StackId
      UserData: !Base64
        Fn::Join:
          - ''
          - - "#!/bin/bash -xv\n"
            - "mkdir /root/install \n"
            - 'hostname '
            - !Join
              - ''
              - - !Ref 'HANAWorkerHostname'
                - '05'
            - "\n"
            - 'echo '
            - !Join
              - ''
              - - !Ref 'HANAWorkerHostname'
                - '05'
                - .
                - !Ref 'DomainName'
            - " > /etc/HOSTNAME\n"
            - 'echo '
            - !Join
              - ''
              - - !Ref 'HANAWorkerHostname'
                - '05'
                - .
                - !Ref 'DomainName'
            - " > /etc/hostname\n"
            - export http_proxy=
            - !Ref 'Proxy'
            - "\n"
            - export https_proxy=
            - !Ref 'Proxy'
            - "\n"
            - export HTTP_PROXY=
            - !Ref 'Proxy'
            - "\n"
            - export HTTPS_PROXY=
            - !Ref 'Proxy'
            - "\n"
            - sh /root/install/writeconfig.sh AWSEFS=
            - !Ref 'AWSEFS'
            - "\n"
            - sh /root/install/writeconfig.sh EFSshared=
            - !If
               - UseEFS
               - !Ref 'EFSshared'
               - !Ref 'AWS::NoValue'
            - "\n"
            - sh /root/install/writeconfig.sh EFSbackup=
            - !If
               - UseEFS
               - !Ref 'EFSbackup'
               - !Ref 'AWS::NoValue'
            - "\n"
            - export no_proxy=localhost,127.0.0.1,169.254.169.254
            - "\n"
            - export NO_PROXY=localhost,127.0.0.1,169.254.169.254
            - "\n"
            #- !If [IfUseSLES, "# SLES\n", "yum install -y wget\n", ]
            #- wget https://s3.amazonaws.com/
            #- !Ref 'PrivateBucket'
            #- "/scripts/download.sh --output-document=/root/install/download.sh\n"
            #- 'sh /root/install/download.sh -b '
            #- !Ref 'PrivateBucket'
            #- ' -c '
            #- !Ref 'CustomStorageConfig'
            #- "\n"
            - "source /etc/os-release\n"
            - "if [ ${ID} == \"sles\" ]; then \n"
            - "   zypper install -y aws-cli \n"
            - "elif [[ ${ID} == \"rhel\" && ${VERSION_ID} != \"7\"* ]]; then \n"
            - "   yum install -y python3 unzip \n"
            - "   curl \"https://s3.amazonaws.com/aws-cli/awscli-bundle.zip\" -o \"/tmp/awscli-bundle.zip\" \n"
            - "   cd /tmp && unzip awscli-bundle.zip \n"
            - "   python3 /tmp/awscli-bundle/install -i /usr/local/aws -b /usr/local/bin/aws \n"
            - "elif [[ ${ID} == \"rhel\" && ${VERSION_ID} == \"7.\"* ]]; then \n"
            - "   curl \"https://s3.amazonaws.com/aws-cli/awscli-bundle.zip\" -o \"/tmp/awscli-bundle.zip\" \n"
            - "   cd /tmp && unzip awscli-bundle.zip \n"
            - "   /tmp/awscli-bundle/install -i /usr/local/aws -b /usr/local/bin/aws \n"
            - "fi \n"
            - "cd /root/install && aws s3 sync s3://"
            - !Ref 'PrivateBucket'
            - "/scripts/ . \n"
            - "chmod 755 /root/install/*.sh\n"
            - "chmod 755 /root/install/*.py\n"
            - 'echo '
            - !Join
              - _
              - - export TABLE_NAME=HANAMonitor_
                - !Ref 'AWS::StackName'
            - " >> /root/install/config.sh\n"
            - 'echo '
            - !Join
              - ''
              - - export TZ_INPUT_PARAM=
                - !Ref 'SAPTZ'
            - " >> /root/install/config.sh\n"
            - 'echo '
            - !Join
              - ''
              - - export SLESBYOSRegCode=
                - !Ref 'SLESBYOSRegCode'
            - " >> /root/install/config.sh\n"
            - 'echo '
            - !Join
              - ''
              - - export DeploymentInterruptQ=
                - !Ref 'DeploymentInterruptQ'
            - " >> /root/install/config.sh\n"
            - 'echo '
            - !Join
              - ''
              - - export MyOS=
                - !FindInMap
                  - SAPAMINameMap
                  - !Ref 'MyOS'
                  - Code
            - " >> /root/install/config.sh\n"
            - sh /root/install/writeconfig.sh MyStackId=
            - !Ref 'AWS::StackId'
            - "\n"
            - sh  /root/install/writeconfig.sh MyStackName=
            - !Ref 'AWS::StackName'
            - "\n"
            - sh /root/install/writeconfig.sh INSTALL_HANA=
            - !Ref 'InstallHANA'
            - "\n"
            - sh /root/install/writeconfig.sh HostCount=
            - !Ref 'HostCount'
            - "\n"
            - sh /root/install/writeconfig.sh SAPInstanceNum=
            - !Ref 'SAPInstanceNum'
            - "\n"
            - sh /root/install/writeconfig.sh http_proxy=
            - !Ref 'Proxy'
            - "\n"
            - sh /root/install/writeconfig.sh HTTP_PROXY=
            - !Ref 'Proxy'
            - "\n"
            - sh /root/install/writeconfig.sh https_proxy=
            - !Ref 'Proxy'
            - "\n"
            - sh /root/install/writeconfig.sh HTTPS_PROXY=
            - !Ref 'Proxy'
            - "\n"
            - sh /root/install/writeconfig.sh AWSEFS=
            - !Ref 'AWSEFS'
            - "\n"
            - sh /root/install/writeconfig.sh EFSshared=
            - !If
               - UseEFS
               - !Ref 'EFSshared'
               - !Ref 'AWS::NoValue'
            - "\n"
            - sh /root/install/writeconfig.sh EFSbackup=
            - !If
               - UseEFS
               - !Ref 'EFSbackup'
               - !Ref 'AWS::NoValue'
            - "\n"
            - sh /root/install/writeconfig.sh no_proxy=localhost,127.0.0.1,169.254.169.254
            - "\n"
            - sh /root/install/writeconfig.sh NO_PROXY=localhost,127.0.0.1,169.254.169.254
            - "\n"
            - sh /root/install/writeconfig.sh FastRestartEnabled=
            - !Ref 'SAPHANAFastRestart'
            - "\n"
            - sh /root/install/writeconfig.sh DomainName=
            - !Ref 'DomainName'
            - "\n"
            - sh /root/install/writeconfig.sh SID=
            - !Ref 'SID'
            - "\n"
            - sh /root/install/writeconfig.sh IsMasterNode=0
            - "\n"
            - sh /root/install/writeconfig.sh IsWorkerNode=1
            - "\n"
            - sh /root/install/writeconfig.sh USR_SAP_VOL=gp2
            - "\n"
            - sh /root/install/writeconfig.sh REGION=
            - !Ref 'AWS::Region'
            - "\n"
            - sh /root/install/writeconfig.sh AutomaticReboot=
            - !Ref 'AutomaticReboot'
            - "\n"
            - sh /root/install/writeconfig.sh HANAMasterHostname=
            - !Ref 'HANAMasterHostname'
            - "\n"
            - "sh /root/install/install-prereq.sh\n"
            - "sh /root/install/install-aws.sh\n"
            - "sh /root/install/setup-hana.sh worker\n"
            - "\n"
      InstanceType: !Ref 'MyInstanceType'
  AutoRecoverAlarmMaster:
    Type: AWS::CloudWatch::Alarm
    Condition: AutoRecoveryMaster
    Properties:
      AlarmDescription: Trigger a recovery when instance status check fails for 5
        consecutive minute.
      Namespace: AWS/EC2
      MetricName: StatusCheckFailed_System
      Statistic: Minimum
      Period: 60
      EvaluationPeriods: 5
      ComparisonOperator: GreaterThanThreshold
      Threshold: 0
      AlarmActions:
        - !Join
          - ''
          - - 'arn:aws:automate:'
            - !Ref 'AWS::Region'
            - :ec2:recover
      Dimensions:
        - Name: InstanceId
          Value: !Ref 'HANAMasterInstance'
  AutoRecoverAlarmWorker1:
    Type: AWS::CloudWatch::Alarm
    Condition: AutoRecoveryWorker1
    Properties:
      AlarmDescription: Trigger a recovery when instance status check fails for 5
        consecutive minutes.
      Namespace: AWS/EC2
      MetricName: StatusCheckFailed_System
      Statistic: Minimum
      Period: 60
      EvaluationPeriods: 5
      ComparisonOperator: GreaterThanThreshold
      Threshold: 0
      AlarmActions:
        - !Join
          - ''
          - - 'arn:aws:automate:'
            - !Ref 'AWS::Region'
            - :ec2:recover
      Dimensions:
        - Name: InstanceId
          Value: !Ref 'HANAWorkerInstance1'
  AutoRecoverAlarmWorker2:
    Type: AWS::CloudWatch::Alarm
    Condition: AutoRecoveryWorker2
    Properties:
      AlarmDescription: Trigger a recovery when instance status check fails for 5
        consecutive minutes.
      Namespace: AWS/EC2
      MetricName: StatusCheckFailed_System
      Statistic: Minimum
      Period: 60
      EvaluationPeriods: 5
      ComparisonOperator: GreaterThanThreshold
      Threshold: 0
      AlarmActions:
        - !Join
          - ''
          - - 'arn:aws:automate:'
            - !Ref 'AWS::Region'
            - :ec2:recover
      Dimensions:
        - Name: InstanceId
          Value: !Ref 'HANAWorkerInstance2'
  AutoRecoverAlarmWorker3:
    Type: AWS::CloudWatch::Alarm
    Condition: AutoRecoveryWorker3
    Properties:
      AlarmDescription: Trigger a recovery when instance status check fails for 5
        consecutive minutes.
      Namespace: AWS/EC2
      MetricName: StatusCheckFailed_System
      Statistic: Minimum
      Period: 60
      EvaluationPeriods: 5
      ComparisonOperator: GreaterThanThreshold
      Threshold: 0
      AlarmActions:
        - !Join
          - ''
          - - 'arn:aws:automate:'
            - !Ref 'AWS::Region'
            - :ec2:recover
      Dimensions:
        - Name: InstanceId
          Value: !Ref 'HANAWorkerInstance3'
  AutoRecoverAlarmWorker4:
    Type: AWS::CloudWatch::Alarm
    Condition: AutoRecoveryWorker4
    Properties:
      AlarmDescription: Trigger a recovery when instance status check fails for 5
        consecutive minutes.
      Namespace: AWS/EC2
      MetricName: StatusCheckFailed_System
      Statistic: Minimum
      Period: 60
      EvaluationPeriods: 5
      ComparisonOperator: GreaterThanThreshold
      Threshold: 0
      AlarmActions:
        - !Join
          - ''
          - - 'arn:aws:automate:'
            - !Ref 'AWS::Region'
            - :ec2:recover
      Dimensions:
        - Name: InstanceId
          Value: !Ref 'HANAWorkerInstance4'
  AutoRecoverAlarmWorker5:
    Type: AWS::CloudWatch::Alarm
    Condition: AutoRecoveryWorker5
    Properties:
      AlarmDescription: Trigger a recovery when instance status check fails for 5
        consecutive minutes.
      Namespace: AWS/EC2
      MetricName: StatusCheckFailed_System
      Statistic: Minimum
      Period: 60
      EvaluationPeriods: 5
      ComparisonOperator: GreaterThanThreshold
      Threshold: 0
      AlarmActions:
        - !Join
          - ''
          - - 'arn:aws:automate:'
            - !Ref 'AWS::Region'
            - :ec2:recover
      Dimensions:
        - Name: InstanceId
          Value: !Ref 'HANAWorkerInstance5'
  EFSshared:
    Type: AWS::EFS::FileSystem
    Condition: UseEFS
    Properties:
      PerformanceMode: generalPurpose
      FileSystemTags:
        - Key: Name
          Value: !Ref 'HANAMasterHostname'
  EFSbackup:
    Type: AWS::EFS::FileSystem
    Condition: UseEFS
    Properties:
      PerformanceMode: generalPurpose
      FileSystemTags:
        - Key: Name
          Value: !Ref 'HANAMasterHostname'
  EFSMTshared:
    Type: AWS::EFS::MountTarget
    DependsOn: EFSshared
    Condition: UseEFS
    Properties:
      FileSystemId: !Ref 'EFSshared'
      SubnetId: !Ref 'HANASubnet'
      SecurityGroups:
        - !Ref 'HANASecurityGroup'
  EFSMTbackup:
    Type: AWS::EFS::MountTarget
    DependsOn: EFSbackup
    Condition: UseEFS
    Properties:
      FileSystemId: !Ref 'EFSbackup'
      SubnetId: !Ref 'HANASubnet'
      SecurityGroups:
        - !Ref 'HANASecurityGroup'
